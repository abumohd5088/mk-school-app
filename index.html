<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Milli Karwaan Public School Balrampur</title>
<link rel="icon" href="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png">
<style>
  :root{
    --brand:#0b4f8a;
    --brand-2:#134e8a;
    --accent:#f6b042;
    --muted:#6b7280;
    --bg:#f4f7fb;
    --card:#ffffff;
    --radius:12px;
    --shadow: 0 8px 28px rgba(10,25,60,0.08);
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:#0b1721; -webkit-font-smoothing:antialiased;}
  a{color:inherit}
  .container{max-width:1100px;margin:18px auto;padding:0 16px;}
  header.top{
    background: linear-gradient(90deg,var(--brand),var(--brand-2));
    color:white;padding:12px;border-radius:10px;display:flex;gap:14px;align-items:center;box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:60;
  }
  header .brand{display:flex;gap:12px;align-items:center}
  header img.logo{height:64px;width:64px;border-radius:10px;background:white;padding:6px;object-fit:contain}
  header h1{font-size:1.1rem;margin:0}
  header p{margin:0;font-size:0.85rem;opacity:0.95}
  header .contact{margin-left:auto;text-align:right;font-size:0.85rem}
  header .contact a{color:white;text-decoration:none;display:block}
  nav.navbar{background:var(--card);padding:10px 14px;margin-top:12px;border-radius:10px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px;position:sticky;top:98px;z-index:50}
  .nav-left{display:flex;gap:8px;flex-wrap:wrap}
  .nav-left a{padding:8px 12px;border-radius:8px;font-weight:600;color:var(--brand-2);text-decoration:none}
  .nav-left a:hover{background:#f1f7ff}
  .dot{margin-left:auto;font-size:22px;cursor:pointer;padding:6px;border-radius:8px;color:var(--brand-2)}
  .menu-panel{position:absolute;right:18px;top:140px;min-width:220px;background:var(--card);border-radius:10px;box-shadow:0 12px 36px rgba(10,25,60,0.12);padding:8px;display:none;z-index:80}
  .menu-panel a{display:block;padding:10px;border-radius:8px;color:var(--brand-2);text-decoration:none}
  .menu-panel a:hover{background:#f3fbff}
  main{margin-top:18px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
  @media(max-width:1000px){.grid{grid-template-columns:1fr;padding-bottom:40px}.menu-panel{right:10px;top:170px}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  h2{color:var(--brand-2);margin:0 0 8px}
  small.muted{color:var(--muted)}
  /* Student form */
  .form-row{display:flex;gap:12px;margin-top:12px}
  .form-row .col{flex:1}
  label{font-weight:600;color:var(--brand-2);display:block;margin-bottom:6px}
  input[type=text], select, textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6eef9;background:#fbfdff}
  button.btn{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:white;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid #e6eef9;padding:9px 14px;border-radius:10px}
  .muted-pill{background:#f1f8ff;padding:8px 12px;border-radius:999px;color:var(--brand-2);display:inline-block}
  /* Homework list */
  .hw-list{list-style:none;padding:0;margin:0;display:grid;gap:10px}
  .hw-item{padding:14px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border-left:4px solid var(--brand-2);box-shadow:0 6px 18px rgba(12,34,60,0.04)}
  .hw-item strong{display:block;color:var(--brand-2);margin-bottom:6px}
  .center{text-align:center}
  /* Teachers */
  .teachers{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .teacher-card{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;border:1px solid #eef6ff}
  .teacher-card .avatar{height:68px;width:68px;border-radius:10px;background:#eef7ff;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--brand-2);font-size:1.1rem}
  /* gallery */
  .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .gallery img{width:100%;height:100px;object-fit:cover;border-radius:8px;cursor:pointer}
  @media(max-width:700px){.gallery{grid-template-columns:repeat(2,1fr)}}
  /* sidebar */
  aside .small-card{margin-bottom:14px}
  .quick-search input, .quick-search select{padding:10px;border-radius:8px;border:1px solid #e6eef9}
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:200}
  .lightbox img{max-width:95%;max-height:85%;border-radius:8px}
  footer.site-footer{margin-top:20px;padding:18px;text-align:center;background:linear-gradient(90deg,var(--brand-2),var(--brand));color:white;border-radius:10px}
  .small-muted{font-size:0.95rem;color:var(--muted)}
</style>
</head>
<body>

<header class="top container" role="banner">
  <div class="brand">
    <img class="logo" src="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png" alt="Milli Karwaan Public School Logo">
    <div>
      <h1>Milli Karwaan Public School Balrampur</h1>
      <p class="small-muted">Boluha Police Chowki Balrampur â€” Learning with care</p>
    </div>
  </div>
  <div class="contact">
    <div>ðŸ“ž <a href="tel:9758919151">9758919151</a></div>
    <div>âœ‰ <a href="mailto:madamsir066@gmail.com">madamsir066@gmail.com</a></div>
  </div>
</header>

<nav class="navbar container" role="navigation">
  <div class="nav-left">
    <a href="#home">Home</a>
    <a href="#homework">Homework</a>
    <a href="#teachers">Teachers</a>
    <a href="#gallery">Gallery</a>
    <a href="#contact">Contact</a>
  </div>
  <div class="dot" id="dotBtn" aria-haspopup="true" aria-expanded="false">â‹®</div>
  <div class="menu-panel card" id="menuPanel" role="menu" aria-hidden="true">
    <a href="#gallery">Gallery</a>
    <a href="#events">Events</a>
    <a href="#notices">Notices</a>
    <a href="#timetable">Timetable</a>
    <a href="admin.html" target="_blank" rel="noopener">Admin Login</a>
    <a href="#" id="downloadSnapshot">Download Snapshot</a>
    <a href="#" id="exportData">Export Data (JSON)</a>
  </div>
</nav>

<main class="container" id="home">
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div>

      <!-- Student Access: MUST be first -->
      <section id="studentSection" class="card" aria-labelledby="studentTitle">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h2 id="studentTitle">Student Access</h2>
            <small class="muted">Enter details first to view class-specific homework</small>
          </div>
        </div>

        <div id="formWrap" style="margin-top:12px;">
          <p class="small-muted">This form is required. Once you submit, your details are saved locally and cannot be edited from this page.</p>
          <div class="form-row" style="margin-top:10px;">
            <div class="col">
              <label for="studentName">Student Name</label>
              <input id="studentName" type="text" placeholder="e.g. Arjun Sharma" />
            </div>
            <div class="col">
              <label for="studentClass">Class (1 - 12)</label>
              <select id="studentClass">
                <option value="">Select Class</option>
              </select>
            </div>
            <div class="col">
              <label for="parentName">Parent's Name</label>
              <input id="parentName" type="text" placeholder="e.g. Mrs Sharma" />
            </div>
          </div>

          <div style="margin-top:14px;display:flex;gap:10px;">
            <button class="btn" id="submitStudent">Submit & Continue</button>
            <button class="ghost" id="clearStudent">Clear</button>
          </div>
        </div>

        <div id="studentWelcome" style="display:none;margin-top:16px;">
          <div class="muted-pill" id="welcomeText">Welcome</div>
        </div>

        <div id="lockedNotice" style="display:none;margin-top:12px;">
          <p class="small-muted">Student details are locked. To change them, clear browser data or contact admin.</p>
        </div>
      </section>

      <!-- Homework -->
      <section id="homework" class="card" style="margin-top:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><h2>Homework</h2><small class="muted">Only homework for the selected class is shown</small></div>
        </div>
        <div id="hwContent" style="margin-top:12px;">
          <div id="noHw" class="card" style="background:#fff7f0;border-left:4px solid #ffb85c;display:none;">
            <p class="small-muted center" style="padding:12px;margin:0"><strong>No homework found for your class yet.</strong></p>
          </div>
          <ul id="hwList" class="hw-list" style="margin-top:12px;"></ul>
        </div>
      </section>

      <!-- Teachers -->
      <section id="teachers" class="card" style="margin-top:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><h2>Teachers</h2><small class="muted">Our dedicated teaching staff</small></div>
        </div>
        <div style="margin-top:12px;" id="teachersGrid" class="teachers"></div>
      </section>

      <!-- Events -->
      <section id="events" class="card" style="margin-top:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><h2>Upcoming Events</h2><small class="muted">Mark dates for school events</small></div>
        </div>
        <div id="eventsList" style="margin-top:12px;"></div>
      </section>

      <!-- Notices -->
      <section id="notices" class="card" style="margin-top:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><h2>Notice Board</h2><small class="muted">Latest announcements</small></div>
        </div>
        <div id="noticeList" style="margin-top:12px;"></div>
      </section>

      <!-- Timetable -->
      <section id="timetable" class="card" style="margin-top:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><h2>Class Timetable (Sample)</h2><small class="muted">Contact admin for full class-wise timetables</small></div>
        </div>
        <div style="margin-top:12px;overflow:auto;">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="text-align:left;color:var(--muted)"><th style="padding:10px;border-bottom:1px solid #eef6ff">Day</th><th style="padding:10px;border-bottom:1px solid #eef6ff">Slot 1</th><th style="padding:10px;border-bottom:1px solid #eef6ff">Slot 2</th><th style="padding:10px;border-bottom:1px solid #eef6ff">Slot 3</th><th style="padding:10px;border-bottom:1px solid #eef6ff">Slot 4</th></tr>
            </thead>
            <tbody id="timetableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Gallery -->
      <section id="gallery" class="card" style="margin-top:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><h2>Gallery</h2><small class="muted">Click images to enlarge</small></div>
        </div>
        <div style="margin-top:12px;" class="gallery" id="galleryGrid"></div>
      </section>

    </div><!-- left end -->

    <!-- RIGHT COLUMN (sidebar) -->
    <aside>

      <div class="card small-card">
        <h3 class="small-muted">Quick Contact</h3>
        <p class="small-muted">Address: Boluha Police Chowki Balrampur</p>
        <p class="small-muted">Phone: <a href="tel:9758919151">9758919151</a></p>
        <p class="small-muted">Email: <a href="mailto:madamsir066@gmail.com">madamsir066@gmail.com</a></p>
      </div>

      <div class="card small-card">
        <h3 class="small-muted">Quick Homework Search</h3>
        <div class="quick-search">
          <select id="qsClass" style="width:100%;margin-bottom:8px;padding:10px;border-radius:8px;border:1px solid #eef6ff">
            <option value="">All Classes</option>
          </select>
          <input id="qsKey" type="text" placeholder="Keyword (e.g. maths)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef6ff;margin-bottom:8px">
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="quickSearch()">Search</button>
            <button class="ghost" onclick="resetSearch()">Reset</button>
          </div>
          <div id="qsResults" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card small-card">
        <h3 class="small-muted">Messages</h3>
        <form id="contactForm" onsubmit="submitContact(event)">
          <label for="msgName">Your Name</label>
          <input id="msgName" required type="text" style="margin-bottom:8px">
          <label for="msgEmail">Your Email</label>
          <input id="msgEmail" required type="email" style="margin-bottom:8px">
          <label for="msgText">Message</label>
          <textarea id="msgText" required rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eef6ff"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" type="submit">Send</button>
            <button type="button" class="ghost" onclick="viewMessages()">View Saved</button>
          </div>
        </form>
      </div>

      <div class="card small-card">
        <h3 class="small-muted">Admin</h3>
        <p class="small-muted">Authorized users only. Admin panel can add/edit/delete homework, teachers, notices and more.</p>
        <div style="display:flex;gap:8px">
          <a class="btn" href="admin.html" target="_blank" rel="noopener">Open Admin</a>
          <button class="ghost" onclick="exportData()">Export</button>
        </div>
      </div>

    </aside>

  </div> <!-- grid end -->

  <footer class="site-footer card" style="margin-top:18px;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <div>
        <strong>Milli Karwaan Public School Balrampur</strong><br>
        <small class="small-muted">Boluha Police Chowki Balrampur â€¢ ðŸ“ž 9758919151 â€¢ âœ‰ madamsir066@gmail.com</small>
      </div>
      <div>
        <small class="small-muted">Local data stored in browser (localStorage). Admin changes will update this data.</small>
      </div>
    </div>
  </footer>

</main>

<!-- lightbox -->
<div class="lightbox" id="lightbox" onclick="hideLightbox()"><img id="lightboxImg" src="" alt="Preview"></div>

<script>
/* -------------- Keys & Helpers -------------- */
const KEY_STUDENT = 'mkps_student';
const KEY_HOMEWORK = 'mkps_homework';
const KEY_TEACHERS = 'mkps_teachers';
const KEY_EVENTS = 'mkps_events';
const KEY_NOTICES = 'mkps_notices';
const KEY_TIMETABLE = 'mkps_timetable';
const KEY_GALLERY = 'mkps_gallery';
const KEY_MESSAGES = 'mkps_messages';
const CLASS_COUNT = 12;
const adminPassword = 'Abutalha'; // for admin.html later

const $ = id => document.getElementById(id);
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k,def=null) => { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; };

/* -------------- Prevent back to form after submission -------------- */
function blockBack() {
  // push a new state and block popstate by pushing again
  history.pushState({page:'post'}, '', location.href);
  window.addEventListener('popstate', function(e){
    // whenever user tries to go back, push state again and keep them forward
    history.pushState({page:'post'}, '', location.href);
  });
}

/* -------------- Seed default data if empty -------------- */
function seedDefaults() {
  if(!load(KEY_HOMEWORK)){
    const hw = {};
    for(let i=1;i<=CLASS_COUNT;i++){
      hw[i] = [
        `Math: Practice problems chapter ${Math.min(i,10)} (20 min)`,
        `English: Read page ${8+i} and write 5 sentences`,
        `Science: Short notes on topic ${i<=6?'Plants':'Energy'}`
      ];
    }
    save(KEY_HOMEWORK, hw);
  }
  if(!load(KEY_TEACHERS)){
    save(KEY_TEACHERS, [
      {name:'Mr. Ali',subject:'Mathematics',phone:'9758919001'},
      {name:'Mrs. Fatima',subject:'English',phone:'9758919002'},
      {name:'Mr. Khan',subject:'Science',phone:'9758919003'}
    ]);
  }
  if(!load(KEY_EVENTS)){
    save(KEY_EVENTS, [
      {title:'Annual Sports Day',date:'2025-08-25',desc:'Sports events for all classes.'},
      {title:'PTM',date:'2025-09-10',desc:'Parents teacher meeting by class.'}
    ]);
  }
  if(!load(KEY_NOTICES)){
    save(KEY_NOTICES, [
      {title:'Holiday Notice',body:'School closed on Friday due to local holiday.'},
      {title:'Fee Reminder',body:'Clear pending fees by month end.'}
    ]);
  }
  if(!load(KEY_TIMETABLE)){
    save(KEY_TIMETABLE, {
      Monday:['Math','English','Science','Computer'],
      Tuesday:['Hindi','Math','Social','Art'],
      Wednesday:['Science','Math','PT','English'],
      Thursday:['Computer','Social','Math','Science'],
      Friday:['English','Math','Assembly','Sports']
    });
  }
  if(!load(KEY_GALLERY)){
    save(KEY_GALLERY, [
      'https://picsum.photos/id/1015/800/600',
      'https://picsum.photos/id/1021/800/600',
      'https://picsum.photos/id/1027/800/600',
      'https://picsum.photos/id/1035/800/600',
      'https://picsum.photos/id/1043/800/600',
      'https://picsum.photos/id/1052/800/600'
    ]);
  }
  if(!load(KEY_MESSAGES)) save(KEY_MESSAGES, []);
}
seedDefaults();

/* -------------- Populate class selects -------------- */
function populateClassSelectors(){
  const sc = $('studentClass'), qs = $('qsClass');
  sc.innerHTML = '<option value="">Select Class</option>';
  qs.innerHTML = '<option value="">All Classes</option>';
  for(let i=1;i<=CLASS_COUNT;i++){
    const o = document.createElement('option'); o.value=i; o.textContent='Class '+i; sc.appendChild(o);
    const o2 = document.createElement('option'); o2.value=i; o2.textContent='Class '+i; qs.appendChild(o2);
  }
}
populateClassSelectors();

/* -------------- Render functions -------------- */
function renderHomeworkFor(classNo){
  const hw = load(KEY_HOMEWORK,{});
  const list = $('hwList');
  list.innerHTML = '';
  if(!classNo){
    $('noHw').style.display = 'block';
    return;
  }
  const items = hw[classNo] || [];
  if(items.length===0){
    $('noHw').style.display = 'block'; return;
  }
  $('noHw').style.display = 'none';
  items.forEach((h,idx)=>{
    const li = document.createElement('li'); li.className='hw-item';
    li.innerHTML = `<strong>${h}</strong><div class="small-muted">Class ${classNo} â€¢ Item ${idx+1}</div>`;
    list.appendChild(li);
  });
}

function renderTeachers(){
  const teachers = load(KEY_TEACHERS,[]);
  const grid = $('teachersGrid'); grid.innerHTML='';
  teachers.forEach(t=>{
    const d = document.createElement('div'); d.className='teacher-card';
    d.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
      <div class="avatar">${t.name.split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase()}</div>
      <div style="flex:1"><div style="font-weight:700;color:var(--brand-2)">${t.name}</div><div style="color:var(--muted)">${t.subject}</div><div style="color:var(--muted);margin-top:6px">ðŸ“ž ${t.phone}</div></div>
    </div>`;
    grid.appendChild(d);
  });
}

function renderEvents(){
  const ev = load(KEY_EVENTS,[]);
  const el = $('eventsList'); el.innerHTML='';
  ev.forEach(e=>{
    const div = document.createElement('div'); div.style.marginBottom='12px';
    div.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="background:linear-gradient(90deg,var(--brand-2),var(--brand));padding:10px;border-radius:8px;color:white;font-weight:700">${(new Date(e.date)).toLocaleDateString()}</div><div><div style="font-weight:700;color:var(--brand-2)">${e.title}</div><div style="color:var(--muted)">${e.desc}</div></div></div>`;
    el.appendChild(div);
  });
}

function renderNotices(){
  const ns = load(KEY_NOTICES,[]);
  const el = $('noticeList'); el.innerHTML='';
  ns.forEach(n=>{
    const div = document.createElement('div'); div.style.marginBottom='10px';
    div.innerHTML = `<div style="font-weight:700;color:var(--brand-2)">${n.title}</div><div style="color:var(--muted)">${n.body}</div>`;
    el.appendChild(div);
  });
}

function renderTimetable(){
  const tt = load(KEY_TIMETABLE,{});
  const body = $('timetableBody'); body.innerHTML='';
  for(const day in tt){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:10px;border-bottom:1px solid #f2f7ff">${day}</td>` + tt[day].map(s=>`<td style="padding:10px;border-bottom:1px solid #f2f7ff">${s}</td>`).join('');
    body.appendChild(tr);
  }
}

function renderGallery(){
  const gallery = load(KEY_GALLERY,[]);
  const g = $('galleryGrid'); g.innerHTML='';
  gallery.forEach(src=>{
    const img = document.createElement('img'); img.src=src; img.alt='School photo'; img.onclick=()=>showLightbox(src);
    g.appendChild(img);
  });
}

/* -------------- Lightbox -------------- */
function showLightbox(src){ $('lightboxImg').src = src; $('lightbox').style.display='flex'; }
function hideLightbox(){ $('lightbox').style.display='none'; }

/* -------------- Student logic: lock on submit -------------- */
function lockStudentUI(){
  $('formWrap').style.display='none';
  $('studentWelcome').style.display='block';
  $('lockedNotice').style.display='block';
}

function unlockStudentUI(){ // not normally used; provided for debug
  $('formWrap').style.display='block';
  $('studentWelcome').style.display='none';
  $('lockedNotice').style.display='none';
}

function initStudent(){
  const st = load(KEY_STUDENT);
  if(st){
    // student exists: show welcome and homework
    $('welcomeText').textContent = `Welcome ${st.name} (Class ${st.cls}) â€” Parent: ${st.parent}`;
    lockStudentUI();
    renderHomeworkFor(st.cls);
    blockBack();
  } else {
    // show form
    $('formWrap').style.display='block';
  }
}

$('submitStudent').addEventListener('click', ()=>{
  const name = $('studentName').value.trim();
  const cls = $('studentClass').value;
  const parent = $('parentName').value.trim();
  if(!name || !cls || !parent){
    alert('Please fill Student Name, Class, and Parent\'s Name.');
    return;
  }
  // Save permanently in localStorage
  save(KEY_STUDENT, {name, cls, parent, ts: Date.now()});
  $('welcomeText').textContent = `Welcome ${name} (Class ${cls}) â€” Parent: ${parent}`;
  lockStudentUI();
  renderHomeworkFor(cls);
  // block back navigation
  blockBack();
  // push a small flash
  setTimeout(()=>{ window.scrollTo({top: document.getElementById('homework').offsetTop - 20, behavior:'smooth'}) },120);
});

$('clearStudent').addEventListener('click', ()=>{
  if(confirm('Clear form fields? This will not remove saved student info if already submitted.')){
    $('studentName').value=''; $('studentClass').value=''; $('parentName').value='';
  }
});

/* -------------- Contact form -------------- */
function submitContact(e){
  e.preventDefault();
  const name = $('msgName').value.trim(); const email = $('msgEmail').value.trim(); const msg = $('msgText').value.trim();
  if(!name || !email || !msg){ alert('Please fill all fields'); return; }
  const arr = load(KEY_MESSAGES,[]);
  arr.unshift({name,email,msg,ts:Date.now()});
  save(KEY_MESSAGES, arr);
  alert('Message saved locally. Admin can view it from admin panel.');
  $('msgName').value=''; $('msgEmail').value=''; $('msgText').value='';
}
document.getElementById('contactForm').addEventListener('submit', submitContact);

function viewMessages(){
  const arr = load(KEY_MESSAGES,[]);
  if(arr.length===0){ alert('No messages saved.'); return; }
  let html = arr.map(m=>`${new Date(m.ts).toLocaleString()}\n${m.name} (${m.email})\n${m.msg}\n----------------`).join('\n\n');
  const w = window.open('','_blank','width=700,height=700,scrollbars=yes');
  w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;padding:12px">'+html+'</pre>');
}

/* -------------- Quick search -------------- */
function quickSearch(){
  const cls = $('qsClass').value;
  const kw = $('qsKey').value.trim().toLowerCase();
  const hw = load(KEY_HOMEWORK,{});
  const results = [];
  if(cls){
    (hw[cls]||[]).forEach(h=>{ if(!kw || h.toLowerCase().includes(kw)) results.push({cls,h}); });
  } else {
    for(const k in hw) (hw[k]||[]).forEach(h=>{ if(!kw || h.toLowerCase().includes(kw)) results.push({cls:k,h}); });
  }
  const out = $('qsResults'); out.innerHTML='';
  if(results.length===0){ out.innerHTML='<div class="small-muted">No results.</div>'; return; }
  const ul = document.createElement('ul'); ul.className='hw-list';
  results.forEach(r=>{ const li=document.createElement('li'); li.className='hw-item'; li.innerHTML=`<strong>Class ${r.cls}:</strong> ${r.h}`; ul.appendChild(li); });
  out.appendChild(ul);
}
function resetSearch(){ $('qsClass').value=''; $('qsKey').value=''; $('qsResults').innerHTML=''; }

/* -------------- Export & Snapshot -------------- */
function exportData(){
  const dump = {
    student: load(KEY_STUDENT),
    homework: load(KEY_HOMEWORK),
    teachers: load(KEY_TEACHERS),
    events: load(KEY_EVENTS),
    notices: load(KEY_NOTICES),
    timetable: load(KEY_TIMETABLE),
    gallery: load(KEY_GALLERY),
    messages: load(KEY_MESSAGES)
  };
  const blob = new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='mkps-data.json'; a.click();
  URL.revokeObjectURL(url);
}
$('exportData').addEventListener('click', (e)=>{ e.preventDefault(); exportData(); });

function downloadSnapshot(e){
  e.preventDefault();
  const hw = load(KEY_HOMEWORK,{});
  let html = '<html><head><meta charset="utf-8"><title>MKPS Snapshot</title></head><body><h1>Milli Karwaan Public School â€” Snapshot</h1>';
  for(const c in hw){
    html += `<h2>Class ${c}</h2><ul>`;
    hw[c].forEach(it=> html += `<li>${it}</li>`);
    html += '</ul>';
  }
  html += `<p>Generated on ${new Date().toLocaleString()}</p></body></html>`;
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='mkps-snapshot.html'; a.click();
  URL.revokeObjectURL(url);
}
$('downloadSnapshot').addEventListener('click', downloadSnapshot);

/* -------------- Menu toggle -------------- */
$('dotBtn').addEventListener('click', ()=>{
  const p = $('menuPanel');
  p.style.display = p.style.display==='block' ? 'none' : 'block';
});
document.addEventListener('click', (e)=>{ if(!e.target.closest('#dotBtn') && !e.target.closest('#menuPanel')) $('menuPanel').style.display='none'; });

/* -------------- Lightbox close on esc -------------- */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') hideLightbox(); });

/* -------------- Init everything -------------- */
function initPage(){
  renderTeachers(); renderEvents(); renderNotices(); renderTimetable(); renderGallery();
  // populate class selectors
  const qs = $('qsClass');
  qs.innerHTML = '<option value="">All Classes</option>';
  for(let i=1;i<=CLASS_COUNT;i++){ qs.appendChild(Object.assign(document.createElement('option'),{value:i,textContent:'Class '+i})); }

  // student initial state
  initStudent();
}
initPage();

</script>

</body>
</html>
