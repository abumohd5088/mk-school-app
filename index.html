<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mili Karwaan Public School — Student Home</title>
<meta name="description" content="Mili Karwaan — personalised student home (class-based). Homework, timetable, notices, events, gallery, attendance, export/import & print."/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* ----------------------------------------------------------------------------
     THEME & LAYOUT
     Professional green-gold theme, responsive layout
     ---------------------------------------------------------------------------- */
  :root{
    --bg:#f6fbf9;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#065f46;
    --accent-2:#0f766e;
    --gold:#f59e0b;
    --glass: rgba(255,255,255,0.85);
    --shadow: 0 10px 30px rgba(6,10,8,0.06);
    --maxw:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#ecfff4);color:#052524}
  a { color: inherit; text-decoration: none; }
  .container{max-width:var(--maxw);margin:0 auto;padding:0 18px}

  /* Header */
  header.site-header{
    position:sticky;top:0;z-index:1100;background:linear-gradient(90deg,var(--accent-2),var(--accent));
    color:white;padding:14px 0;box-shadow:0 6px 18px rgba(3,7,7,0.12)
  }
  .nav-inner{display:flex;align-items:center;gap:12px;justify-content:space-between;max-width:var(--maxw);margin:0 auto;padding:0 18px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:64px;height:64px;border-radius:12px;background:#fff;padding:6px;object-fit:contain}
  .brand .title{font-family:'Montserrat',sans-serif;font-weight:700;font-size:1.05rem}
  .top-actions{display:flex;align-items:center;gap:10px}
  .btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12)}
  .pill{background:var(--gold);color:#162018;padding:8px 12px;border-radius:999px;font-weight:800}

  /* Main layout (sidebar minimal: 3-dot menu) */
  main.app{display:grid;grid-template-columns:1fr;gap:18px;padding:22px 0}
  .layout{display:grid;grid-template-columns:280px 1fr;gap:18px;align-items:start}
  /* For "3-dot" small sidebar we use a collapsible left rail on big screens */
  .left-rail{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);height:calc(100vh - 140px);position:sticky;top:70px;overflow:auto}
  .left-rail .compact{display:flex;flex-direction:column;gap:8px}
  .menu-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;color:#083229;font-weight:700}
  .menu-item:hover{background:#f0fff7;transform:translateX(6px)}
  .menu-item.active{background:linear-gradient(90deg,#ecffef,#f0fff7);border-left:4px solid var(--accent-2)}
  .search{display:flex;gap:8px}

  /* Top kebab (3-dot) quick menu for mobile and users who prefer top */
  .kebab{background:rgba(255,255,255,0.06);padding:10px;border-radius:10px;cursor:pointer}
  .kebab:hover{transform:rotate(6deg)}

  /* Content */
  .content{min-height:70vh}
  .content .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:14px}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-2{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .home-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}

  /* lists */
  .list .item{padding:12px;border-radius:10px;background:#f8fff8;border-left:6px solid var(--gold);margin-bottom:10px}
  .small{font-size:0.95rem;color:var(--muted)}

  /* gallery */
  .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
  .gallery-grid img{width:100%;height:100px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid rgba(2,8,6,0.03)}

  /* news ticker */
  .ticker{background:linear-gradient(90deg,#f7fff7,#fbfff8);padding:8px;border-radius:10px;border-left:4px solid var(--accent);overflow:hidden}
  .ticker-inner{display:inline-block;white-space:nowrap;animation:marquee 20s linear infinite}
  @keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}

  /* modal / lightbox */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,6,0.6);z-index:2000;opacity:0;pointer-events:none;transition:opacity .12s}
  .modal.open{opacity:1;pointer-events:auto}
  .modal .box{background:white;padding:14px;border-radius:12px;max-width:980px;width:94%}
  .close-x{position:absolute;right:12px;top:12px;background:#fff;border-radius:50%;padding:6px;cursor:pointer}

  /* floating admin */
  .admin-fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:999px;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:white;border:none;font-size:18px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 32px rgba(2,8,6,0.2);z-index:2100}

  /* responsive */
  @media (max-width:980px){
    .layout{grid-template-columns:1fr; padding:0 12px}
    .left-rail{position:relative;height:auto;top:0}
    .grid-2{grid-template-columns:1fr}
    .grid-3{grid-template-columns:1fr 1fr}
  }
  @media (max-width:560px){
    .grid-3{grid-template-columns:1fr}
    .brand .title{font-size:0.95rem}
    .kebab{display:inline-flex}
  }

  /* small helpers */
  .muted{color:var(--muted)}
  .center{text-align:center}
  .nowrap{white-space:nowrap}
  .tiny{font-size:0.85rem}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(2,8,6,0.06)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f0fff4;color:#06402f;font-weight:800}
</style>
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="nav-inner container">
      <div class="brand" aria-hidden="false">
        <img class="logo" id="siteLogo" src="https://i.postimg.cc/Zqm9DSvt/erasebg-transformed.png" alt="MKPS logo">
        <div>
          <div class="title">Mili Karwaan Public School</div>
          <div class="small muted">Baluha Police Chowki, Balrampur</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="kebab" id="kebabBtn" title="Quick actions" aria-label="Quick actions">
          <i class="fas fa-ellipsis-v"></i>
        </div>
        <div id="quickPanel" style="display:none;">
          <!-- quick panel created by JS -->
        </div>
        <div id="userGreeting" class="muted small">Hello — please enter name & class</div>
        <button class="btn pill" id="admissionsBtn">Apply Now</button>
      </div>
    </div>
  </header>

  <!-- Main app -->
  <main class="app container" role="main">
    <div class="layout" id="layoutWrap">
      <!-- Left rail (compact menu) -->
      <aside class="left-rail" role="navigation" aria-label="Main menu">
        <div class="compact">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <div class="muted tiny">Quick Menu</div>
            <div class="muted tiny nowrap">Class view <span id="railClass" class="badge">—</span></div>
          </div>

          <div id="menuItems">
            <div class="menu-item active" data-view="home"><i class="fas fa-house"></i> Home</div>
            <div class="menu-item" data-view="homework"><i class="fas fa-book"></i> Homework</div>
            <div class="menu-item" data-view="timetable"><i class="fas fa-clock"></i> Timetable</div>
            <div class="menu-item" data-view="notices"><i class="fas fa-bullhorn"></i> Notices</div>
            <div class="menu-item" data-view="events"><i class="fas fa-calendar-alt"></i> Events</div>
            <div class="menu-item" data-view="gallery"><i class="fas fa-images"></i> Gallery</div>
            <div class="menu-item" data-view="attendance"><i class="fas fa-check-circle"></i> Attendance</div>
            <div class="menu-item" data-view="fees"><i class="fas fa-money-bill"></i> Fees</div>
            <div class="menu-item" data-view="contact"><i class="fas fa-phone"></i> Contact</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="exportBtn"><i class="fas fa-file-export"></i> Export</button>
            <button class="btn ghost" id="importBtn"><i class="fas fa-file-import"></i> Import</button>
          </div>

          <div style="margin-top:14px">
            <div class="muted tiny">Owner quick:</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="printBtn"><i class="fas fa-print"></i></button>
              <button class="btn" id="csvBtn"><i class="fas fa-file-csv"></i></button>
              <button class="btn ghost" id="resetBtn" title="Reset demo/local">Reset</button>
            </div>
          </div>

        </div>
      </aside>

      <!-- Right / main content -->
      <section class="content" id="mainContent" aria-live="polite">
        <!-- Welcome / login overlay (first-run) -->
        <div id="welcomeOverlay" class="card" role="dialog" aria-modal="true" style="max-width:920px;margin:8px auto;">
          <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap">
            <div style="flex:1;min-width:260px">
              <h2 style="margin:0;color:var(--accent)">Welcome to Mili Karwaan</h2>
              <p class="muted" style="margin-top:6px">Enter your name and select class (1–8). The dashboard will show content for your class only.</p>

              <div style="margin-top:12px">
                <label class="small" for="inputName">Full name</label>
                <input id="inputName" placeholder="e.g. Rahul Sharma" />
              </div>

              <div style="margin-top:10px">
                <label class="small" for="inputClass">Class</label>
                <select id="inputClass">
                  <option value="">Select class</option>
                  <option>Class 1</option>
                  <option>Class 2</option>
                  <option>Class 3</option>
                  <option>Class 4</option>
                  <option>Class 5</option>
                  <option>Class 6</option>
                  <option>Class 7</option>
                  <option>Class 8</option>
                </select>
              </div>

              <div style="margin-top:12px;display:flex;gap:8px">
                <button class="btn pill" id="startBtn">Enter Dashboard</button>
                <button class="btn ghost" id="demoBtn2">Demo (Class 6)</button>
              </div>

              <p class="muted tiny" style="margin-top:10px">Data is stored locally in your browser (demo). Admin panel is available separately.</p>
            </div>

            <div style="width:320px">
              <div style="background:linear-gradient(180deg,#f7fffa,#fff);padding:12px;border-radius:10px">
                <h4 style="margin:0">What you get</h4>
                <ul class="muted" style="margin-top:8px">
                  <li>Personalised Homework & Timetable</li>
                  <li>Notices for your class</li>
                  <li>Events, Gallery, Attendance & Fees preview</li>
                  <li>Export / Import data, print reports</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Dynamic views container -->
        <div id="viewsWrap">
          <!-- Home dashboard -->
          <div id="view-home" class="card view">
            <div class="section-title">
              <div>
                <h3 style="margin:0">Dashboard</h3>
                <div class="small muted">Personalised for <strong id="vwName">—</strong> • <span id="vwClass">—</span></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="ticker" title="Latest notices"><div class="ticker-inner" id="tickerInner">Loading notices… • </div></div>
                <button class="btn" id="refreshBtn" title="Refresh local data"><i class="fas fa-sync"></i></button>
              </div>
            </div>

            <div class="grid-2">
              <div>
                <div class="home-cards">
                  <div class="card">
                    <h4 style="margin-top:0">Homework — latest</h4>
                    <div id="homeworkPreview" class="list"></div>
                  </div>

                  <div class="card">
                    <h4 style="margin-top:0">Announcements</h4>
                    <div id="annPreview"></div>
                  </div>
                </div>

                <div class="card" style="margin-top:12px">
                  <h4 style="margin-top:0">Events</h4>
                  <ul id="eventsPreview" class="muted"></ul>
                </div>

                <div class="card" style="margin-top:12px">
                  <h4 style="margin-top:0">Search (homework & notices)</h4>
                  <div style="display:flex;gap:8px">
                    <input id="globalSearch" placeholder="Search homework, announcements…" />
                    <button class="btn" id="searchBtn"><i class="fas fa-search"></i></button>
                  </div>
                  <div id="searchResults" style="margin-top:8px"></div>
                </div>
              </div>

              <aside>
                <div class="card center">
                  <div style="font-size:28px;font-weight:800" id="statStudents">0</div>
                  <div class="muted">Students (site demo)</div>
                </div>

                <div class="card" style="margin-top:12px">
                  <h4 style="margin-top:0">Attendance</h4>
                  <div id="attendanceBox" class="muted">—</div>
                </div>

                <div class="card" style="margin-top:12px">
                  <h4 style="margin-top:0">Quick Actions</h4>
                  <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                    <button class="btn" id="goHomework">Open Homework</button>
                    <button class="btn" id="goTimetable">Open Timetable</button>
                    <button class="btn ghost" id="exportLocal">Export Data</button>
                  </div>
                </div>
              </aside>

            </div>
          </div>

          <!-- Homework view -->
          <div id="view-homework" class="card view hidden">
            <div class="section-title">
              <h3 style="margin:0">Homework — <span id="hwClassLabel"></span></h3>
              <div><span class="muted tiny">You can export or print this list</span></div>
            </div>
            <div id="hwList"></div>
          </div>

          <!-- Timetable view -->
          <div id="view-timetable" class="card view hidden">
            <div class="section-title">
              <h3 style="margin:0">Timetable — <span id="ttClassLabel"></span></h3>
              <div><button class="btn" id="printTimetableBtn"><i class="fas fa-print"></i> Print</button></div>
            </div>
            <div id="ttTable"></div>
          </div>

          <!-- Notices view -->
          <div id="view-notices" class="card view hidden">
            <div class="section-title"><h3 style="margin:0">Notices — <span id="ntClassLabel"></span></h3></div>
            <div id="noticesList"></div>
          </div>

          <!-- Events view -->
          <div id="view-events" class="card view hidden">
            <div class="section-title"><h3 style="margin:0">Events</h3></div>
            <div id="eventsList"></div>
          </div>

          <!-- Gallery view -->
          <div id="view-gallery" class="card view hidden">
            <div class="section-title"><h3 style="margin:0">Gallery</h3></div>
            <div id="galleryGrid" class="gallery-grid"></div>
          </div>

          <!-- Attendance view -->
          <div id="view-attendance" class="card view hidden">
            <div class="section-title"><h3 style="margin:0">Attendance</h3></div>
            <div id="attendanceDetails"></div>
          </div>

          <!-- Fees view -->
          <div id="view-fees" class="card view hidden">
            <div class="section-title"><h3 style="margin:0">Fees & Payments</h3></div>
            <div id="feesPreview"></div>
          </div>

          <!-- Contact view -->
          <div id="view-contact" class="card view hidden">
            <div class="section-title"><h3 style="margin:0">Contact & Enquiry</h3></div>
            <div class="card">
              <form id="contactForm">
                <input id="cname" placeholder="Your name" required />
                <input id="cinfo" placeholder="Phone or email" required />
                <textarea id="cmsg" rows="4" placeholder="Message"></textarea>
                <div style="margin-top:8px;display:flex;gap:8px">
                  <button class="btn">Send</button>
                  <button type="button" class="btn ghost" id="viewEnquiries">View local enquiries</button>
                </div>
              </form>
            </div>
            <div class="small muted" style="margin-top:8px">Phone: +91 97589 19151 • Email: madamsir066@gmail.com</div>
          </div>

        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:12px 0;margin-top:16px">
    <div class="container" style="display:flex;justify-content:space-between;align-items:center">
      <div>© Mili Karwaan Public School — Baluha Police Chowki, Balrampur</div>
      <div class="small">Phone: <strong>+91 97589 19151</strong> • Email: <strong>madamsir066@gmail.com</strong></div>
    </div>
  </footer>

  <!-- Floating admin button -->
  <button id="adminFab" class="admin-fab" title="Admin (staff)"><i class="fas fa-user-shield"></i></button>

  <!-- Modal / Lightbox -->
  <div id="modal" class="modal" aria-hidden="true"><div class="box" id="modalBox"></div></div>

  <!-- Large inline script — everything here is client-side localStorage & UI logic -->
  <script>
  /* ----------------------------------------------------------------------------
     MKPS — Single-file Home (class-filtered) v1.0
     - Stores all content in localStorage under key MKPS_DATA_v1
     - First-run asks for student name & class and stores session MKPS_SESSION
     - Views: home, homework, timetable, notices, events, gallery, attendance, fees, contact
     - Owner tools: export/import JSON, print, CSV export (students)
     - Admin: floating button prompts password "Abutalha", opens admin.html (if present)
     ---------------------------------------------------------------------------- */

  (function(){
    const STORAGE_KEY = 'MKPS_DATA_v1';
    const SESSION_KEY = 'MKPS_SESSION';
    const DEFAULT_DATA = {
      studentsCount: 1200,
      homework: {
        'Class 1': [{id:'h-c1-1',subject:'English',title:'Alphabet Practice',due:'2025-11-25',notes:'Practice A-F.'}],
        'Class 2': [{id:'h-c2-1',subject:'Math',title:'Additions',due:'2025-11-26',notes:'Q1-10'}],
        'Class 3': [{id:'h-c3-1',subject:'EVS',title:'Plant Study',due:'2025-11-28',notes:'Collect leaves'}],
        'Class 4': [{id:'h-c4-1',subject:'Math',title:'Multiplication',due:'2025-11-29',notes:'Tables 2-5'}],
        'Class 5': [{id:'h-c5-1',subject:'Science',title:'Water Cycle',due:'2025-12-01',notes:'Draw diagram'}],
        'Class 6': [{id:'h-c6-1',subject:'Mathematics',title:'Algebra',due:'2025-11-25',notes:'Exercise 5.3 Q1-15.'}],
        'Class 7': [{id:'h-c7-1',subject:'English',title:'Essay',due:'2025-11-27',notes:'Write 200 words'}],
        'Class 8': [{id:'h-c8-1',subject:'Science',title:'Lab Report',due:'2025-11-30',notes:'Submit lab report'}]
      },
      timetable: {
        'Class 6': [{day:'Mon',time:'8:00-9:00',subject:'Mathematics'},{day:'Mon',time:'9:00-10:00',subject:'Science'}],
        'Class 1': [{day:'Mon',time:'9:00-9:30',subject:'English'}]
      },
      announcements: {
        'Class 6': [{id:'a1-c6',title:'Science Exhibition',date:'2025-12-10',body:'Project presentation in hall.'}],
        'Class 1': [{id:'a1-c1',title:'Drawing Competition',date:'2025-11-28',body:'Bring colours and pencils.'}]
      },
      events: [{id:'ev1',title:'Annual Sports Day',date:'2025-12-06'},{id:'ev2',title:'Diwali Holiday',date:'2025-10-31'}],
      gallery: [
        'https://i.postimg.cc/Zqm9DSvt/erasebg-transformed.png'
      ],
      attendance: {'Class 6':{present:28,total:30}, 'Class 1':{present:29,total:30}},
      fees: [{'id':'f1','studentName':'Demo Student','class':'Class 6','amount':15000,'status':'unpaid'}]
    };

    // load/save
    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT_DATA));
      }catch(e){
        console.error('loadData error',e);
        return JSON.parse(JSON.stringify(DEFAULT_DATA));
      }
    }
    function saveData(d){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }catch(e){console.error(e);}
    }

    let DATA = loadData();

    // Session: name + class
    function loadSession(){ try{ const s = localStorage.getItem(SESSION_KEY); return s ? JSON.parse(s) : null; }catch(e){return null;} }
    function saveSession(sess){ localStorage.setItem(SESSION_KEY, JSON.stringify(sess)); }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); window.location.reload(); }

    let SESSION = loadSession();

    // Utilities
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = (p='id') => p + Math.random().toString(36).slice(2,9);

    // Elements
    const welcomeOverlay = $('#welcomeOverlay');
    const inputName = $('#inputName');
    const inputClass = $('#inputClass');
    const startBtn = $('#startBtn');
    const demoBtn = $('#demoBtn2');

    const vwName = $('#vwName');
    const vwClass = $('#vwClass');
    const railClass = $('#railClass');
    const userGreeting = $('#userGreeting');
    const tickerInner = $('#tickerInner');
    const statStudents = $('#statStudents');

    // views mapping
    const views = {
      home: '#view-home',
      homework: '#view-homework',
      timetable: '#view-timetable',
      notices: '#view-notices',
      events: '#view-events',
      gallery: '#view-gallery',
      attendance: '#view-attendance',
      fees: '#view-fees',
      contact: '#view-contact'
    };

    // initial setup: if session exists, hide welcome and render
    function init(){
      if(SESSION && SESSION.name && SESSION.class){
        welcomeOverlay.style.display = 'none';
        applySession(SESSION);
      } else {
        welcomeOverlay.style.display = 'block';
      }
      // populate mini stats
      $('#statStudents').textContent = DATA.studentsCount || 0;
      // Setup menu event listeners
      $$('#menuItems .menu-item').forEach(el => {
        el.addEventListener('click', ()=> {
          $$('#menuItems .menu-item').forEach(x=>x.classList.remove('active'));
          el.classList.add('active');
          const view = el.dataset.view;
          navigate(view);
        });
      });

      // kebab quick actions
      $('#kebabBtn').addEventListener('click', toggleQuickPanel);

      // data owners
      $('#exportBtn').addEventListener('click', exportAll);
      $('#importBtn').addEventListener('click', importAll);
      $('#resetBtn').addEventListener('click', resetLocal);

      $('#refreshBtn').addEventListener('click', ()=>{ DATA = loadData(); renderCurrent(); alert('Refreshed local data'); });
      $('#printBtn').addEventListener('click', ()=> window.print());
      $('#csvBtn').addEventListener('click', exportStudentsCSV);

      // global interactions
      startBtn.addEventListener('click', onStart);
      demoBtn.addEventListener('click', ()=> { inputName.value='Demo Student'; inputClass.value='Class 6'; onStart(); });

      // home quick
      $('#goHomework').addEventListener('click', ()=> navigate('homework'));
      $('#goTimetable').addEventListener('click', ()=> navigate('timetable'));
      $('#searchBtn').addEventListener('click', doSearch);
      $('#globalSearch').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

      // contact
      $('#contactForm').addEventListener('submit', (e)=>{ e.preventDefault(); saveEnquiry(); });

      // export/import inside content
      $('#exportLocal').addEventListener('click', exportAll);

      // print timetable
      $('#printTimetableBtn').addEventListener('click', ()=> { printElement('#ttTable'); });

      // admin fab
      $('#adminFab').addEventListener('click', adminPrompt);

      // gallery lightbox handler delegated
      document.addEventListener('click', (e)=> {
        if(e.target.matches('.gallery-grid img')) {
          openModal(`<img src="${e.target.src}" style="width:100%;height:auto;border-radius:8px" />`);
        }
        if(e.target.matches('.closeModal') || e.target.closest('.closeModal')) closeModal();
      });

      // when storage changes in other tabs
      window.addEventListener('storage', (ev)=> { if(ev.key === STORAGE_KEY){ DATA = loadData(); renderCurrent(); } });

      // ensure initial render
      renderTicker();
      renderCurrent();
      animateCounters();
    }

    function applySession(sess){
      SESSION = sess;
      saveSession(SESSION);
      vwName.textContent = SESSION.name;
      vwClass.textContent = SESSION.class;
      railClass.textContent = SESSION.class;
      userGreeting.textContent = `Welcome, ${SESSION.name} (${SESSION.class})`;
      // show first view home
      navigate('home');
      renderCurrent();
      animateCounters();
    }

    function onStart(){
      const name = (inputName.value || '').trim();
      const cls = (inputClass.value || '').trim();
      if(!name || !cls){ alert('Please enter name and select class.'); return; }
      applySession({name, class: cls});
      welcomeOverlay.style.display = 'none';
    }

    function navigate(view){
      // hide all view elements
      Object.values(views).forEach(sel => {
        const el = document.querySelector(sel);
        if(el) el.classList.add('hidden');
      });
      const sel = views[view];
      const el = sel ? document.querySelector(sel) : null;
      if(el) el.classList.remove('hidden');
      // highlight left-rail menu active
      $$('#menuItems .menu-item').forEach(item => item.classList.toggle('active', item.dataset.view === view));
      // update header small labels
      if(view === 'homework') { $('#hwClassLabel').textContent = SESSION.class; }
      if(view === 'timetable') { $('#ttClassLabel').textContent = SESSION.class; }
      if(view === 'notices') { $('#ntClassLabel').textContent = SESSION.class; }
      // update view-specific content
      renderCurrent();
      // scroll top
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function renderCurrent(){
      // uses SESSION.class to filter DATA
      if(!SESSION) return;
      const cls = SESSION.class;
      // HOME preview
      renderHomeworkPreview(cls);
      renderAnnouncementsPreview(cls);
      renderEventsPreview();
      renderAttendancePreview(cls);
      renderGallery();
      // full lists for views if visible
      if(!document.querySelector(views.homework).classList.contains('hidden')) renderHomeworkList(cls);
      if(!document.querySelector(views.timetable).classList.contains('hidden')) renderTimetable(cls);
      if(!document.querySelector(views.notices).classList.contains('hidden')) renderNoticesList(cls);
      if(!document.querySelector(views.events).classList.contains('hidden')) renderEventsList();
      if(!document.querySelector(views.gallery).classList.contains('hidden')) renderGallery();
      if(!document.querySelector(views.attendance).classList.contains('hidden')) renderAttendanceDetails(cls);
      if(!document.querySelector(views.fees).classList.contains('hidden')) renderFees();
      // header small info
      $('#vwName').textContent = SESSION.name;
      $('#vwClass').textContent = SESSION.class;
      railClass.textContent = SESSION.class;
      $('#vwClass').textContent = SESSION.class;
      // ticker
      renderTicker();
    }

    /* --------------- Render helper functions --------------- */

    function renderHomeworkPreview(cls){
      const list = DATA.homework[cls] || [];
      const node = $('#homeworkPreview');
      if(!list.length) node.innerHTML = '<div class="muted">No homework assigned.</div>';
      else node.innerHTML = list.slice(0,3).map(h => `<div class="item"><strong>${escapeHtml(h.subject)} — ${escapeHtml(h.title)}</strong><div class="muted">Due: ${escapeHtml(h.due)}</div><div style="margin-top:8px">${escapeHtml(h.notes)}</div></div>`).join('');
    }
    function renderHomeworkList(cls){
      const list = DATA.homework[cls] || [];
      const node = $('#hwList');
      if(!list.length) node.innerHTML = '<div class="muted card">No homework for this class.</div>';
      else node.innerHTML = list.map(h=>`<div class="item"><strong>${escapeHtml(h.subject)} — ${escapeHtml(h.title)}</strong><div class="muted">Due: ${escapeHtml(h.due)}</div><div style="margin-top:8px">${escapeHtml(h.notes)}</div></div>`).join('');
    }

    function renderAnnouncementsPreview(cls){
      const arr = DATA.announcements[cls] || [];
      const node = $('#annPreview');
      if(!arr.length) node.innerHTML = '<div class="muted">No announcements.</div>';
      else node.innerHTML = arr.slice(0,3).map(a=>`<div style="margin-bottom:8px"><strong>${escapeHtml(a.title)}</strong><div class="muted">${escapeHtml(a.date)}</div><div style="margin-top:6px">${escapeHtml(a.body)}</div></div>`).join('');
    }
    function renderNoticesList(cls){
      const arr = DATA.announcements[cls] || [];
      const node = $('#noticesList');
      if(!arr.length) node.innerHTML = '<div class="muted card">No notices for this class.</div>';
      else node.innerHTML = arr.map(a=>`<div class="card"><h4>${escapeHtml(a.title)}</h4><div class="muted">${escapeHtml(a.date)}</div><p>${escapeHtml(a.body)}</p></div>`).join('');
    }

    function renderEventsPreview(){
      const node = $('#eventsPreview');
      node.innerHTML = DATA.events.map(ev=>`<li>${escapeHtml(ev.title)} — ${escapeHtml(ev.date)}</li>`).join('');
    }
    function renderEventsList(){
      const node = $('#eventsList');
      node.innerHTML = DATA.events.map(ev=>`<div class="card"><strong>${escapeHtml(ev.title)}</strong><div class="muted">${escapeHtml(ev.date)}</div></div>`).join('');
    }

    function renderTimetable(cls){
      const arr = DATA.timetable[cls] || [];
      const node = $('#ttTable');
      if(!arr.length){ node.innerHTML = '<div class="muted card">No timetable available.</div>'; return; }
      node.innerHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:8px">Day</th><th style="text-align:left;padding:8px">Time</th><th style="text-align:left;padding:8px">Subject</th></tr></thead><tbody>${arr.map(r=>`<tr><td style="padding:8px">${escapeHtml(r.day)}</td><td style="padding:8px">${escapeHtml(r.time)}</td><td style="padding:8px">${escapeHtml(r.subject)}</td></tr>`).join('')}</tbody></table>`;
    }

    function renderGallery(){
      const node = $('#galleryGrid');
      node.innerHTML = (DATA.gallery || []).map(src=>`<img src="${src}" alt="gallery" />`).join('');
    }

    function renderAttendancePreview(cls){
      const a = DATA.attendance[cls];
      const node = $('#attendanceBox');
      if(!a) node.innerHTML = '<div class="muted">No attendance data.</div>';
      else node.innerHTML = `<div style="font-weight:800">${a.present}/${a.total}</div><div class="muted">${Math.round((a.present/a.total)*100)}% present</div>`;
    }
    function renderAttendanceDetails(cls){
      const a = DATA.attendance[cls];
      const node = $('#attendanceDetails');
      if(!a) node.innerHTML = '<div class="muted card">No attendance records.</div>';
      else node.innerHTML = `<div class="card"><h4>Attendance — ${escapeHtml(cls)}</h4><div>Present: ${a.present}</div><div>Total: ${a.total}</div><div class="muted">Percentage: ${Math.round((a.present/a.total)*100)}%</div></div>`;
    }

    function renderFees(){
      const node = $('#feesPreview');
      const f = (DATA.fees || []).filter(x=> x.class === SESSION.class || true).slice(0,5);
      if(!f.length) node.innerHTML = '<div class="muted card">No fees data.</div>';
      else node.innerHTML = f.map(fi=>`<div class="card"><strong>${escapeHtml(fi.name || fi.studentName || '')}</strong><div>Class: ${escapeHtml(fi.class)}</div><div>Amount: ₹${escapeHtml(String(fi.amount))}</div><div>Status: <strong>${escapeHtml(fi.status)}</strong></div></div>`).join('');
    }

    function renderTicker(){
      // produce a long repeating string of notices (global)
      const allNotices = [];
      Object.keys(DATA.announcements || {}).forEach(cls => {
        (DATA.announcements[cls]||[]).forEach(n => allNotices.push(`${n.title} (${cls})`));
      });
      if(!DATA.events || !DATA.events.length) allNotices.push('No events scheduled');
      else DATA.events.forEach(ev => allNotices.push(`${ev.title} on ${ev.date}`));
      const t = allNotices.join(' • ') + ' • ' + allNotices.join(' • ');
      $('#tickerInner').textContent = t || 'Welcome to Mili Karwaan • ';
    }

    /* ------------------ Search ------------------ */
    function doSearch(){
      const q = ($('#globalSearch').value || '').trim().toLowerCase();
      if(!q){ $('#searchResults').innerHTML = '<div class="muted">Enter search term</div>'; return; }
      const cls = SESSION.class;
      const hw = (DATA.homework[cls] || []).filter(h => (h.title + ' ' + h.subject + ' ' + h.notes).toLowerCase().includes(q));
      const ann = (DATA.announcements[cls] || []).filter(a => (a.title + ' ' + a.body).toLowerCase().includes(q));
      let html = '';
      if(hw.length){ html += `<div><strong>Homework</strong>${hw.map(h=>`<div class="item"><strong>${escapeHtml(h.subject)} — ${escapeHtml(h.title)}</strong><div class="muted">Due: ${escapeHtml(h.due)}</div></div>`).join('')}</div>`; }
      if(ann.length){ html += `<div style="margin-top:8px"><strong>Announcements</strong>${ann.map(a=>`<div class="item"><strong>${escapeHtml(a.title)}</strong><div class="muted">${escapeHtml(a.date)}</div><div>${escapeHtml(a.body)}</div></div>`).join('')}</div>`; }
      if(!html) html = '<div class="muted">No results</div>';
      $('#searchResults').innerHTML = html;
    }

    /* --------------- Owner tools: export/import/reset --------------- */
    function exportAll(){
      const blob = new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mkps-data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      alert('Exported local data (mkps-data.json)');
    }
    function importAll(){
      const input = document.createElement('input'); input.type='file'; input.accept='.json';
      input.onchange = ()=> {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ()=> {
          try{
            const parsed = JSON.parse(r.result);
            DATA = parsed; saveData(DATA); alert('Imported data (local)'); renderCurrent();
          }catch(err){ alert('Invalid JSON'); }
        };
        r.readAsText(f);
      };
      input.click();
    }
    function resetLocal(){
      if(!confirm('Reset local demo data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(SESSION_KEY);
      DATA = loadData();
      alert('Local data removed. Reloading.');
      location.reload();
    }

    function exportStudentsCSV(){
      // demo: flatten studentsCount into CSV example
      const rows = [['name','role','class','phone','email']];
      rows.push(['Demo Student','student','Class 6','9876543210','demo@example.com']);
      const blob = new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='mkps-users.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* --------------- Contact / Enquiries --------------- */
    function saveEnquiry(){
      const name = $('#cname').value.trim(); const info = $('#cinfo').value.trim(); const msg = $('#cmsg').value.trim();
      if(!name || !info){ alert('Please provide name and contact.'); return; }
      const enquiries = JSON.parse(localStorage.getItem('MKPS_ENQUIRIES') || '[]');
      enquiries.unshift({id:uid('q'),name,info,msg,at:new Date().toISOString(),class: SESSION.class});
      localStorage.setItem('MKPS_ENQUIRIES', JSON.stringify(enquiries));
      alert('Enquiry saved locally. Admin can view after login.');
      $('#contactForm').reset();
    }
    $('#viewEnquiries').addEventListener('click', ()=> {
      const list = JSON.parse(localStorage.getItem('MKPS_ENQUIRIES') || '[]');
      if(!list.length) return alert('No enquiries');
      openModal('<h3>Local enquiries</h3>' + list.map(q=>`<div class="card"><strong>${escapeHtml(q.name)}</strong> (${escapeHtml(q.class)})<div class="muted">${escapeHtml(q.info)}</div><div style="margin-top:6px">${escapeHtml(q.msg)}</div></div>`).join('') + '<div style="text-align:right"><button class="closeModal btn ghost">Close</button></div>');
    });

    /* --------------- Modal helpers --------------- */
    function openModal(html){
      const modal = $('#modal'); const box = $('#modalBox');
      box.innerHTML = html + `<div style="text-align:right;margin-top:8px"><button class="closeModal btn ghost">Close</button></div>`;
      modal.classList.add('open');
    }
    function closeModal(){ $('#modal').classList.remove('open'); $('#modalBox').innerHTML = ''; }

    /* --------------- Printing helpers --------------- */
    function printElement(selector){
      const el = document.querySelector(selector);
      if(!el) return alert('Nothing to print');
      const w = window.open('','_blank');
      w.document.write('<html><head><title>Print</title><style>body{font-family:Arial;padding:18px}</style></head><body>');
      w.document.write(el.outerHTML);
      w.document.write('</body></html>');
      w.document.close();
      w.print();
    }

    /* --------------- Admin prompt --------------- */
    function adminPrompt(){
      const pwd = prompt('Admin password:');
      if(!pwd) return;
      if(String(pwd) === 'Abutalha'){
        // If admin.html exists on server, open it. Otherwise, open an on-the-fly admin UI (basic).
        // We choose: open dynamic admin window created from current DATA so admin can edit locally right away.
        openAdminWindow();
      } else {
        alert('Access Denied');
      }
    }

    function openAdminWindow(){
      // Create a full admin UI as a blob and open in new tab, sharing data via localStorage key.
      const adminHtml = generateAdminHtml();
      const blob = new Blob([adminHtml], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      window.open(url,'_blank');
    }

    function generateAdminHtml(){
      // The admin file reads/writes to same STORAGE_KEY so changes reflect in home when refreshed.
      const rawData = JSON.stringify(DATA,null,2).replace(/</g,'&lt;');
      return `
<!doctype html>
<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MKPS Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>body{font-family:Poppins,Arial;background:#021621;color:#cfeee3;padding:18px} .card{background:linear-gradient(180deg,#012a25,#021a1a);padding:12px;border-radius:8px;margin-bottom:10px} input,textarea,select{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#cfeee3} button{padding:8px 10px;border-radius:8px;border:none;background:linear-gradient(90deg,#0f766e,#d97706);color:#021} table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.04)}</style>
</head><body>
<h2>MKPS — Local Admin (Demo)</h2>
<p class="muted">You are editing local data only. Changes save to localStorage under the same key so the home page will reflect them after reload.</p>

<div class="card">
  <h4>Raw Data (editable)</h4>
  <textarea id="rawData" rows="12">${rawData}</textarea>
  <div style="margin-top:8px"><button id="saveBtn">Save changes</button> <button id="exportBtn">Export JSON</button> <button id="closeBtn">Close</button></div>
</div>

<div class="card">
  <h4>Quick Actions</h4>
  <button id="addNotice">Add Notice (for any class)</button>
  <button id="addHW">Add Homework (class)</button>
  <button id="addEvent">Add Event</button>
</div>

<script>
  const KEY='${STORAGE_KEY}';
  function load(){ try{ const r = localStorage.getItem(KEY); return r? JSON.parse(r) : null; } catch(e){ return null; } }
  function save(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }

  document.getElementById('saveBtn').addEventListener('click', ()=>{
    try{
      const parsed = JSON.parse(document.getElementById('rawData').value);
      save(parsed);
      alert('Saved to localStorage');
    }catch(e){ alert('Invalid JSON'); }
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([document.getElementById('rawData').value], {type:'application/json'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='mkps-admin-data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
  });

  document.getElementById('closeBtn').addEventListener('click', ()=> window.close());

  document.getElementById('addNotice').addEventListener('click', ()=>{
    const cls = prompt('Class (e.g. Class 6):'); if(!cls) return;
    const title = prompt('Title:'); if(!title) return;
    const date = prompt('Date (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
    const body = prompt('Details:','');
    const d = load() || {};
    d.announcements = d.announcements || {};
    d.announcements[cls] = d.announcements[cls] || [];
    d.announcements[cls].unshift({id:'n'+Math.random().toString(36).slice(2,8),title,date,body});
    save(d);
    document.getElementById('rawData').value = JSON.stringify(d,null,2);
    alert('Notice added.');
  });

  document.getElementById('addHW').addEventListener('click', ()=>{
    const cls = prompt('Class (e.g. Class 6):'); if(!cls) return;
    const sub = prompt('Subject:','Mathematics'); const title = prompt('Title:','Exercise'); const due = prompt('Due (YYYY-MM-DD):'); const notes = prompt('Notes:','');
    const d = load() || {};
    d.homework = d.homework || {};
    d.homework[cls] = d.homework[cls] || [];
    d.homework[cls].unshift({id:'h'+Math.random().toString(36).slice(2,8),subject:sub,title,due,notes});
    save(d); document.getElementById('rawData').value = JSON.stringify(d,null,2); alert('Homework added.');
  });

  document.getElementById('addEvent').addEventListener('click', ()=>{
    const title = prompt('Event title:'); if(!title) return; const date = prompt('Date:','2025-12-01'); const d = load() || {};
    d.events = d.events || []; d.events.unshift({id:'e'+Math.random().toString(36).slice(2,8),title,date}); save(d); document.getElementById('rawData').value = JSON.stringify(d,null,2); alert('Event added.');
  });
</script>
</body></html>
      `;
    }

    /* --------------- Small utilities --------------- */
    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* --------------- Quick panel (kebab) --------------- */
    let quickOpen = false;
    function toggleQuickPanel(){
      quickOpen = !quickOpen;
      if(quickOpen){
        const panel = document.createElement('div');
        panel.style.position='absolute'; panel.style.right='18px'; panel.style.top='64px'; panel.style.background='white'; panel.style.padding='12px'; panel.style.borderRadius='10px'; panel.style.boxShadow='0 12px 30px rgba(2,8,6,0.12)';
        panel.id = 'quickPanelInner';
        panel.innerHTML = `
          <div style="min-width:260px">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>Quick actions</strong><button id="closeQuick" style="background:transparent;border:none;cursor:pointer"><i class="fas fa-times"></i></button></div>
            <div style="margin-top:8px">
              <button class="btn" id="qaAddNotice">Add Notice</button>
              <button class="btn ghost" id="qaAddHw">Add Homework</button>
              <button class="btn" id="qaImport">Import JSON</button>
            </div>
            <div style="margin-top:8px" class="small muted">Owner tools (local)</div>
          </div>
        `;
        document.body.appendChild(panel);
        document.getElementById('closeQuick').addEventListener('click', ()=> { document.getElementById('quickPanelInner').remove(); quickOpen=false; });
        document.getElementById('qaAddNotice').addEventListener('click', ()=> { document.getElementById('quickPanelInner').remove(); quickOpen=false; const cls = prompt('Class (e.g. Class 6):'); if(!cls) return; const title = prompt('Title:'); const date = prompt('Date (YYYY-MM-DD):', new Date().toISOString().slice(0,10)); const body = prompt('Details:',''); DATA.announcements[cls] = DATA.announcements[cls] || []; DATA.announcements[cls].unshift({id:'n'+Math.random().toString(36).slice(2,8),title,date,body}); saveData(DATA); renderCurrent(); alert('Added notice'); });
        document.getElementById('qaAddHw').addEventListener('click', ()=> { document.getElementById('quickPanelInner').remove(); quickOpen=false; const cls = prompt('Class (e.g. Class 6):'); if(!cls) return; const sub = prompt('Subject:','Math'); const title = prompt('Title:','Exercise'); const due = prompt('Due (YYYY-MM-DD):'); const notes = prompt('Notes:',''); DATA.homework[cls] = DATA.homework[cls] || []; DATA.homework[cls].unshift({id:'h'+Math.random().toString(36).slice(2,8),subject:sub,title,due,notes}); saveData(DATA); renderCurrent(); alert('Added homework'); });
        document.getElementById('qaImport').addEventListener('click', ()=> { document.getElementById('quickPanelInner').remove(); quickOpen=false; importAll(); });
      } else {
        const el = document.getElementById('quickPanelInner'); if(el) el.remove();
      }
    }

    /* --------------- Modal close handling --------------- */
    $('#modal').addEventListener('click', (e)=> { if(e.target.id === 'modal') closeModal(); });

    /* --------------- Admin (floating) handled above --------------- */

    /* ---------- small UI niceties ---------- */
    $('#refreshBtn').addEventListener('click', ()=> { animateCounters(); });

    function animateCounters(){
      $$('.counter').forEach(c=>{
        const target = +c.dataset.target || 0; let start=0; const step = Math.max(1, Math.floor(target/80));
        const t = setInterval(()=>{ start += step; c.textContent = start; if(start>=target){ c.textContent = target; clearInterval(t); } }, 12);
      });
      // main stat
      $('#statStudents').textContent = (DATA.studentsCount || 0);
    }

    /* --------------- Admin window generator already provided --------------- */

    // tiny helper to print safe console friendly messages
    console.debug('MKPS home script loaded — localStorage key:', STORAGE_KEY);

    // initialize
    init();

  })();
  </script>
</body>
</html>
