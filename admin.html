<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Milli Karwaan Public School Balrampur</title>
  <link rel="icon" href="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png">
  <style>
    /* ---- Basic theme & layout ---- */
    :root{
      --bg:#f5f8fb;
      --card:#ffffff;
      --primary:#0b4f8a;
      --accent:#f6b042;
      --muted:#6b7280;
      --danger:#dc3545;
      --success:#28a745;
      --radius:12px;
      --shadow: 0 8px 30px rgba(10,25,60,0.06);
      --maxw:1200px;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;
      background:linear-gradient(180deg,#eef6ff 0%, #f5f8fb 100%);
      color:#071232;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
    }
    header{
      background:linear-gradient(90deg,var(--primary),#134e8a);
      color:white;
      padding:14px 20px;
      display:flex;
      gap:14px;
      align-items:center;
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:30;
    }
    header img{height:52px;width:52px;border-radius:10px;background:white;padding:6px;object-fit:contain}
    header .hgroup{line-height:1}
    header h1{margin:0;font-size:1.05rem;letter-spacing:0.2px}
    header p{margin:0;font-size:0.85rem;opacity:0.95}
    main{max-width:var(--maxw);margin:20px auto;padding:0 16px 60px}

    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
    @media(max-width:960px){ .grid{grid-template-columns:1fr} }

    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{padding:10px;border-radius:10px;border:1px solid rgba(11,79,138,0.06);background:white;text-align:left;cursor:pointer}
    .nav button.active{background:linear-gradient(90deg,#eef6ff,#f8fbff);border-color:rgba(11,79,138,0.08)}
    .muted{color:var(--muted);font-size:0.95rem}
    .small{font-size:0.92rem;color:var(--muted)}
    h2{margin:0 0 6px 0}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e9f0f8;background:#fbfeff}
    .flex{display:flex;gap:8px;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;background:#f1f8ff;color:var(--primary);font-weight:700}
    .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--primary),#134e8a);color:white}
    .btn.ghost{background:transparent;border:1px solid #eef6ff;color:var(--primary)}
    .btn.warn{background:var(--accent);color:#071232}
    .btn.danger{background:var(--danger);color:white}
    table{width:100%;border-collapse:collapse}
    table th,table td{padding:8px;border-bottom:1px solid #f2f7ff;text-align:left;font-size:0.95rem}

    .list{max-height:56vh;overflow:auto;padding-right:6px}
    .hidden{display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,12,28,0.45);z-index:200}
    .modal .box{width:94%;max-width:980px;background:white;border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(6,12,28,0.35);max-height:86vh;overflow:auto}
    .note{background:#fff9ec;border-left:4px solid var(--accent);padding:10px;border-radius:8px}
    .kbd{background:#0f1722;color:#f8fafc;padding:6px 8px;border-radius:6px;font-size:0.85rem}
    footer{max-width:var(--maxw);margin:10px auto 30px;padding:0 16px;color:var(--muted);font-size:0.9rem;text-align:center}
    .searchRow{display:flex;gap:8px;align-items:center}
    .chip{background:#f1f8ff;padding:6px 10px;border-radius:999px;color:var(--primary);font-weight:700}
  </style>
</head>
<body>
  <header>
    <img src="https://i.postimg.cc/ryGx49TB/erasebg-transformed.png" alt="logo">
    <div class="hgroup">
      <h1>Admin Panel — Milli Karwaan Public School</h1>
      <p class="small">Manage site content (client-side demo). Admin password: <strong>Abutalha</strong></p>
    </div>
  </header>

  <main>
    <!-- LOGIN CARD -->
    <section id="loginCard" class="card">
      <h2>Admin Login (Demo)</h2>
      <p class="small">This admin is a local demo — it edits browser localStorage used by index.html. Not secure for production.</p>

      <div style="margin-top:12px;max-width:680px;display:grid;gap:10px">
        <div class="searchRow">
          <input id="adminUser" placeholder="username (optional)" />
          <input id="adminPass" placeholder="password" type="password" />
        </div>
        <div class="flex">
          <button class="btn primary" id="loginBtn">Login</button>
          <button class="btn ghost" id="demoBtn">Fill Demo Password</button>
          <button class="btn" id="viewOnlyBtn">Open View-Only</button>
        </div>
        <div id="loginError" class="small" style="color:var(--danger);display:none"></div>
      </div>
    </section>

    <!-- ADMIN UI -->
    <section id="adminUI" class="grid hidden">
      <aside class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div class="small">Admin Menu</div>
            <div style="font-weight:800;margin-top:6px">Control Center</div>
          </div>
          <div class="badge" id="updatedBadge">—</div>
        </div>

        <nav class="nav" id="menuNav">
          <button data-tab="dashboard" class="active">Dashboard</button>
          <button data-tab="homework">Homework</button>
          <button data-tab="teachers">Teachers</button>
          <button data-tab="events">Events</button>
          <button data-tab="notices">Notices</button>
          <button data-tab="timetable">Timetable</button>
          <button data-tab="gallery">Gallery</button>
          <button data-tab="messages">Messages</button>
          <button data-tab="storage">Storage Viewer</button>
          <button data-tab="settings">Settings</button>
          <button id="logoutBtn" style="margin-top:12px;background:#fff6f6;color:var(--danger);border:1px solid rgba(220,53,69,0.08)">Logout</button>
        </nav>

        <div style="margin-top:12px" class="note">
          <strong>Note:</strong> After edits, admin writes a timestamp to <code>mkps_update</code> so index.html auto-refreshes.
        </div>
      </aside>

      <main>
        <!-- Dashboard -->
        <section id="tab-dashboard" class="card tab">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2>Dashboard</h2>
              <p class="small">Quick stats & actions</p>
            </div>
            <div class="flex">
              <button class="btn ghost" onclick="renderAll()">Reload</button>
              <button class="btn" onclick="exportAll()">Export JSON</button>
              <button class="btn warn" onclick="seedConfirm()">Seed Sample Data</button>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px">
            <div class="card"><div class="small">Homework</div><div id="statHW" style="font-weight:800;font-size:1.2rem">0</div></div>
            <div class="card"><div class="small">Teachers</div><div id="statTeachers" style="font-weight:800;font-size:1.2rem">0</div></div>
            <div class="card"><div class="small">Events</div><div id="statEvents" style="font-weight:800;font-size:1.2rem">0</div></div>
            <div class="card"><div class="small">Unread Messages</div><div id="statMsgs" style="font-weight:800;font-size:1.2rem">0</div></div>
          </div>

          <div id="recentAct" style="margin-top:12px" class="small muted"></div>
        </section>

        <!-- Homework -->
        <section id="tab-homework" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Homework</h2><p class="small">Add / Edit / Delete per class (1–12)</p></div>
            <div class="flex">
              <button class="btn primary" onclick="openHwForm()">+ Add</button>
              <button class="btn ghost" onclick="bulkAddSample()">Bulk Sample</button>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
            <div class="card list" style="padding:8px">
              <table>
                <thead><tr><th>Class</th><th>Subject</th><th>Teacher</th><th>Text</th><th>Date</th><th>Action</th></tr></thead>
                <tbody id="hwTable"></tbody>
              </table>
            </div>

            <div class="card">
              <h4 class="small">Add / Edit Homework</h4>
              <label>Class</label><select id="hwClass"></select>
              <label style="margin-top:8px">Subject</label><input id="hwSubject" placeholder="Mathematics">
              <label style="margin-top:8px">Teacher</label><select id="hwTeacher"></select>
              <label style="margin-top:8px">Details</label><textarea id="hwText" rows="4"></textarea>
              <label style="margin-top:8px">Date</label><input type="date" id="hwDate">
              <div style="margin-top:10px" class="flex">
                <button class="btn primary" onclick="saveHomework()">Save</button>
                <button class="btn ghost" onclick="clearHwForm()">Clear</button>
              </div>
              <input type="hidden" id="hwEditId">
            </div>
          </div>
        </section>

        <!-- Teachers -->
        <section id="tab-teachers" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Teachers</h2><p class="small">Manage teacher directory</p></div>
            <div><button class="btn primary" onclick="openTeacherForm()">+ Add</button></div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
            <div class="card list" style="padding:8px">
              <table>
                <thead><tr><th>Name</th><th>Subject</th><th>Phone</th><th>Action</th></tr></thead>
                <tbody id="teachersTable"></tbody>
              </table>
            </div>

            <div class="card">
              <h4 class="small">Add / Edit Teacher</h4>
              <label>Name</label><input id="tName">
              <label style="margin-top:8px">Subject</label><input id="tSubject">
              <label style="margin-top:8px">Phone</label><input id="tPhone">
              <label style="margin-top:8px">Email</label><input id="tEmail">
              <div style="margin-top:10px" class="flex">
                <button class="btn primary" onclick="saveTeacher()">Save</button>
                <button class="btn ghost" onclick="clearTeacherForm()">Clear</button>
              </div>
              <input type="hidden" id="tEditId">
            </div>
          </div>
        </section>

        <!-- Events -->
        <section id="tab-events" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Events</h2><p class="small">School events & calendar</p></div>
            <div><button class="btn primary" onclick="openEventForm()">+ Add</button></div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
            <div class="card list" style="padding:8px">
              <table>
                <thead><tr><th>Date</th><th>Title</th><th>Description</th><th>Action</th></tr></thead>
                <tbody id="eventsTable"></tbody>
              </table>
            </div>

            <div class="card">
              <h4 class="small">Add / Edit Event</h4>
              <label>Title</label><input id="eTitle">
              <label style="margin-top:8px">Date</label><input id="eDate" type="date">
              <label style="margin-top:8px">Description</label><textarea id="eDesc" rows="4"></textarea>
              <div style="margin-top:10px" class="flex">
                <button class="btn primary" onclick="saveEvent()">Save</button>
                <button class="btn ghost" onclick="clearEventForm()">Clear</button>
              </div>
              <input type="hidden" id="eEditId">
            </div>
          </div>
        </section>

        <!-- Notices -->
        <section id="tab-notices" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Notices</h2><p class="small">Important announcements (priority)</p></div>
            <div><button class="btn primary" onclick="openNoticeForm()">+ Add</button></div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
            <div class="card list" style="padding:8px">
              <table>
                <thead><tr><th>Title</th><th>Body</th><th>Priority</th><th>Action</th></tr></thead>
                <tbody id="noticesTable"></tbody>
              </table>
            </div>

            <div class="card">
              <h4 class="small">Add / Edit Notice</h4>
              <label>Title</label><input id="nTitle">
              <label style="margin-top:8px">Body</label><textarea id="nBody" rows="4"></textarea>
              <label style="margin-top:8px">Priority</label><select id="nPriority"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option></select>
              <div style="margin-top:10px" class="flex">
                <button class="btn primary" onclick="saveNotice()">Save</button>
                <button class="btn ghost" onclick="clearNoticeForm()">Clear</button>
              </div>
              <input type="hidden" id="nEditId">
            </div>
          </div>
        </section>

        <!-- Timetable -->
        <section id="tab-timetable" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Timetable</h2><p class="small">Class timetable rows</p></div>
            <div><button class="btn primary" onclick="openTimetableForm()">+ Add Row</button></div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
            <div class="card list" style="padding:8px">
              <table>
                <thead><tr><th>Day</th><th>Slot1</th><th>Slot2</th><th>Slot3</th><th>Slot4</th><th>Action</th></tr></thead>
                <tbody id="timetableTable"></tbody>
              </table>
            </div>

            <div class="card">
              <h4 class="small">Add / Edit Row</h4>
              <label>Day</label><input id="ttDay" placeholder="Monday">
              <label style="margin-top:8px">Slot 1</label><input id="tt1">
              <label style="margin-top:8px">Slot 2</label><input id="tt2">
              <label style="margin-top:8px">Slot 3</label><input id="tt3">
              <label style="margin-top:8px">Slot 4</label><input id="tt4">
              <div style="margin-top:10px" class="flex">
                <button class="btn primary" onclick="saveTimetable()">Save</button>
                <button class="btn ghost" onclick="clearTimetableForm()">Clear</button>
              </div>
              <input type="hidden" id="ttEditId">
            </div>
          </div>
        </section>

        <!-- Gallery -->
        <section id="tab-gallery" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Gallery</h2><p class="small">Store image URLs for index gallery</p></div>
            <div><button class="btn primary" onclick="openGalleryForm()">+ Add</button></div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px">
            <div class="card list" style="padding:8px">
              <table>
                <thead><tr><th>Preview</th><th>URL</th><th>Action</th></tr></thead>
                <tbody id="galleryTable"></tbody>
              </table>
            </div>

            <div class="card">
              <h4 class="small">Add / Edit Photo URL</h4>
              <label>Image URL</label><input id="gUrl" placeholder="https://...">
              <div style="margin-top:10px" class="flex">
                <button class="btn primary" onclick="saveGallery()">Save</button>
                <button class="btn ghost" onclick="clearGalleryForm()">Clear</button>
              </div>
              <input type="hidden" id="gEditId">
            </div>
          </div>
        </section>

        <!-- Messages -->
        <section id="tab-messages" class="card tab hidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h2>Messages</h2><p class="small">Messages sent from contact form on index</p></div>
            <div><button class="btn primary" onclick="markAllRead()">Mark All Read</button></div>
          </div>

          <div style="margin-top:12px" class="card list" id="messagesCard" style="padding:8px">
            <table>
              <thead><tr><th>Date</th><th>Name</th><th>Email</th><th>Message</th><th>Action</th></tr></thead>
              <tbody id="messagesTable"></tbody>
            </table>
          </div>
        </section>

        <!-- Storage Viewer -->
        <section id="tab-storage" class="card tab hidden">
          <h2>LocalStorage Viewer / Raw Editor</h2>
          <p class="small">Directly view/edit mkps_* keys. Use carefully.</p>

          <div style="display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px">
            <div class="card">
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <select id="lsKeySelect"></select>
                <button class="btn" onclick="viewLS()">View</button>
                <button class="btn ghost" onclick="deleteLS()">Delete</button>
                <button class="btn ghost" onclick="renderAll()">Refresh</button>
              </div>
              <pre id="lsViewer">// select a key then View</pre>
            </div>

            <div class="card">
              <h4 class="small">Raw JSON Editor</h4>
              <textarea id="lsEditor" rows="12" placeholder='Paste JSON here'></textarea>
              <div style="margin-top:8px" class="flex">
                <button class="btn primary" onclick="saveLS()">Save</button>
                <button class="btn ghost" onclick="clearEditor()">Clear</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section id="tab-settings" class="card tab hidden">
          <h2>Settings & Data</h2>
          <p class="small">Export / Import / Reset keys</p>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
            <button class="btn primary" onclick="exportAll()">Export All JSON</button>
            <label class="btn ghost" style="cursor:pointer">Import JSON<input id="importFile" type="file" accept=".json" style="display:none" onchange="importAll(event)"></label>
            <button class="btn warn" onclick="seedConfirm()">Seed Sample Data</button>
            <button class="btn danger" onclick="clearAllConfirm()">Clear ALL mkps_* Data</button>
            <button class="btn" onclick="downloadSnapshot()">Download Snapshot (HTML)</button>
          </div>

          <div style="margin-top:12px" class="card small">
            <strong>Storage keys:</strong>
            <ul>
              <li>mkps_student</li>
              <li>mkps_homework</li>
              <li>mkps_teachers</li>
              <li>mkps_events</li>
              <li>mkps_notices</li>
              <li>mkps_timetable</li>
              <li>mkps_gallery</li>
              <li>mkps_messages</li>
              <li>mkps_update</li>
            </ul>
            <div class="small muted">Reminder: password is <strong>Abutalha</strong> (client-side demo only).</div>
          </div>
        </section>

      </main>
    </section>

    <div class="card small muted">
      Tip: Open the public site (index.html) in another tab to observe changes live. Admin writes `mkps_update` timestamp after edits.
    </div>
  </main>

  <footer>© Milli Karwaan Public School Balrampur — Admin Panel (Demo)</footer>

  <!-- Confirm modal -->
  <div id="confirmModal" class="modal"><div class="box"><h3 id="confirmTitle">Confirm</h3><p id="confirmText"></p><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn ghost" onclick="closeConfirm()">Cancel</button><button id="confirmOk" class="btn danger">Confirm</button></div></div></div>

  <script>
    /* ============================
       Admin panel script (single-file)
       - Uses localStorage keys shared with index.html
       - Admin demo password: Abutalha
       - After any change set mkps_update timestamp so index.html can refresh
       - Inline comments explain sections
    ============================ */

    /* ---------- Keys ---------- */
    const K_STUDENT = 'mkps_student';
    const K_HOMEWORK = 'mkps_homework';
    const K_TEACHERS = 'mkps_teachers';
    const K_EVENTS = 'mkps_events';
    const K_NOTICES = 'mkps_notices';
    const K_TIMETABLE = 'mkps_timetable';
    const K_GALLERY = 'mkps_gallery';
    const K_MESSAGES = 'mkps_messages';
    const K_UPDATE = 'mkps_update';

    /* ---------- Helpers ---------- */
    const $ = id => document.getElementById(id);
    const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    const parse = (k, def=null) => {
      try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch(e){ console.warn('parse err',k,e); return def; }
    };
    const store = (k, v) => { localStorage.setItem(k, JSON.stringify(v)); localStorage.setItem(K_UPDATE, Date.now().toString()); };
    const rm = (k) => { localStorage.removeItem(k); localStorage.setItem(K_UPDATE, Date.now().toString()); };

    /* ---------- Auth ---------- */
    const DEMO_PW = 'Abutalha';
    $('demoBtn').addEventListener('click', ()=> $('adminPass').value = DEMO_PW);
    $('viewOnlyBtn').addEventListener('click', ()=> { $('loginCard').classList.add('hidden'); $('adminUI').classList.remove('hidden'); initUI(true); });

    $('loginBtn').addEventListener('click', ()=> {
      const pw = $('adminPass').value;
      if(pw === DEMO_PW){
        sessionStorage.setItem('mkps_admin_logged_in','1');
        $('loginCard').classList.add('hidden');
        $('adminUI').classList.remove('hidden');
        initUI(false);
      } else {
        $('loginError').style.display = 'block';
        $('loginError').textContent = 'Invalid password';
      }
    });

    $('logoutBtn').addEventListener('click', ()=> { if(confirm('Logout?')) location.reload(); });

    /* ---------- Confirm modal ---------- */
    let confirmCb = null;
    function showConfirm(title, text, okLabel='Confirm', cb=null){
      $('confirmTitle').textContent = title;
      $('confirmText').textContent = text;
      $('confirmOk').textContent = okLabel;
      confirmCb = cb;
      $('confirmModal').style.display = 'flex';
    }
    function closeConfirm(){ $('confirmModal').style.display = 'none'; confirmCb = null; }
    $('confirmOk').addEventListener('click', ()=> { if(confirmCb) confirmCb(); closeConfirm(); });

    /* ---------- Seed sample data ---------- */
    function seedDefaults(){
      // Homework: object keyed by class number -> array
      const hw = {};
      for(let i=1;i<=12;i++){
        hw[i] = [
          { id: uid(), subject: 'Mathematics', details: `Practice chapter ${Math.min(i+2,12)} exercises`, date: new Date().toISOString().slice(0,10), teacher: 'Mr. Ali' },
          { id: uid(), subject: 'English', details: `Read page ${10+i} & write summary`, date: new Date().toISOString().slice(0,10), teacher: 'Mrs. Fatima' }
        ];
      }
      store(K_HOMEWORK, hw);

      // Teachers
      store(K_TEACHERS, [
        { id: uid(), name: 'Mr. Ali', subject: 'Mathematics', phone: '9758919001', email: 'ali@mkps.edu' },
        { id: uid(), name: 'Mrs. Fatima', subject: 'English', phone: '9758919002', email: 'fatima@mkps.edu' },
        { id: uid(), name: 'Mr. Khan', subject: 'Science', phone: '9758919003', email: 'khan@mkps.edu' }
      ]);

      // Events
      store(K_EVENTS, [
        { id: uid(), title: 'Annual Sports Day', date: '2025-08-25', desc: 'Sports & prizes' },
        { id: uid(), title: 'Parent-Teacher Meeting', date: '2025-09-10', desc: 'Hall — 10:00 AM' }
      ]);

      // Notices
      store(K_NOTICES, [
        { id: uid(), title: 'Holiday Notice', body: 'School closed on Friday', priority: 'high' },
        { id: uid(), title: 'Fee Reminder', body: 'Please clear fees by month end', priority: 'medium' }
      ]);

      // Timetable
      store(K_TIMETABLE, {
        Monday: ['Math','English','Science','Computer'],
        Tuesday: ['Hindi','Math','Social','Art'],
        Wednesday: ['Science','Math','PT','English'],
        Thursday: ['Computer','Social','Math','Science'],
        Friday: ['English','Math','Assembly','Sports']
      });

      // Gallery
      store(K_GALLERY, [
        'https://picsum.photos/id/1015/800/600',
        'https://picsum.photos/id/1021/800/600',
        'https://picsum.photos/id/1032/800/600'
      ]);

      // Messages empty
      store(K_MESSAGES, []);
      alert('Sample data seeded.');
      renderAll();
    }

    function seedConfirm(){ showConfirm('Seed sample data', 'This will write sample mkps_* data (does not overwrite mkps_student). Continue?', 'Seed', seedDefaults); }

    /* ---------- Clear all ---------- */
    function clearAllConfirm(){ showConfirm('Clear all mkps_* data', 'This will remove all mkps_* keys from localStorage. Continue?', 'Clear', clearAll); }
    function clearAll(){
      [K_HOMEWORK,K_TEACHERS,K_EVENTS,K_NOTICES,K_TIMETABLE,K_GALLERY,K_MESSAGES,K_STUDENT].forEach(k=> localStorage.removeItem(k));
      localStorage.setItem(K_UPDATE, Date.now().toString());
      renderAll();
      alert('Cleared.');
    }

    /* ---------- Export / Import ---------- */
    function exportAll(){
      const dump = {
        [K_STUDENT]: parse(K_STUDENT,null),
        [K_HOMEWORK]: parse(K_HOMEWORK,{}),
        [K_TEACHERS]: parse(K_TEACHERS,[]),
        [K_EVENTS]: parse(K_EVENTS,[]),
        [K_NOTICES]: parse(K_NOTICES,[]),
        [K_TIMETABLE]: parse(K_TIMETABLE,{}),
        [K_GALLERY]: parse(K_GALLERY,[]),
        [K_MESSAGES]: parse(K_MESSAGES,[])
      };
      const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mkps-data.json'; a.click(); URL.revokeObjectURL(url);
    }

    function importAll(e){
      const f = e.target.files[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=> {
        try{
          const obj = JSON.parse(fr.result);
          if(obj[K_HOMEWORK]) store(K_HOMEWORK, obj[K_HOMEWORK]);
          if(obj[K_TEACHERS]) store(K_TEACHERS, obj[K_TEACHERS]);
          if(obj[K_EVENTS]) store(K_EVENTS, obj[K_EVENTS]);
          if(obj[K_NOTICES]) store(K_NOTICES, obj[K_NOTICES]);
          if(obj[K_TIMETABLE]) store(K_TIMETABLE, obj[K_TIMETABLE]);
          if(obj[K_GALLERY]) store(K_GALLERY, obj[K_GALLERY]);
          if(obj[K_MESSAGES]) store(K_MESSAGES, obj[K_MESSAGES]);
          if(obj[K_STUDENT]) store(K_STUDENT, obj[K_STUDENT]);
          alert('Import complete.');
          renderAll();
        } catch(err){ alert('Invalid JSON'); console.error(err); }
      };
      fr.readAsText(f);
    }
    $('importFile').addEventListener('change', importAll);

    /* ---------- Homework CRUD ---------- */
    function populateClassOptions(){
      const sel = $('hwClass'); sel.innerHTML='';
      for(let i=1;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent='Class '+i; sel.appendChild(o); }
    }
    populateClassOptions();

    function renderHomework(){
      const hw = parse(K_HOMEWORK,{});
      const tbody = $('hwTable'); tbody.innerHTML = '';
      for(const cls in hw){
        (hw[cls]||[]).forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${cls}</td><td>${escape(item.subject)}</td><td>${escape(item.teacher||'')}</td><td style="max-width:360px">${escape(item.details)}</td><td>${escape(item.date||'')}</td>
            <td><button class="btn" onclick="editHw('${cls}','${item.id}')">Edit</button> <button class="btn ghost" onclick="delHw('${cls}','${item.id}')">Delete</button></td>`;
          tbody.appendChild(tr);
        });
      }
      updateStats();
    }

    function openHwForm(){ openTab('homework'); clearHwForm(); renderTeachersSelect(); $('hwDate').value = new Date().toISOString().slice(0,10); }
    function clearHwForm(){ $('hwClass').value='1'; $('hwSubject').value=''; $('hwTeacher').innerHTML=''; $('hwText').value=''; $('hwDate').value=''; $('hwEditId').value=''; }
    function saveHomework(){
      const cls = $('hwClass').value;
      const subject = $('hwSubject').value.trim();
      const teacher = $('hwTeacher').value;
      const details = $('hwText').value.trim();
      const date = $('hwDate').value;
      if(!subject || !details) return alert('Subject and details required');
      const hw = parse(K_HOMEWORK,{});
      if(!hw[cls]) hw[cls]=[];
      const editId = $('hwEditId').value;
      if(editId){
        const idx = (hw[cls]||[]).findIndex(x=>x.id===editId);
        if(idx>=0){ hw[cls][idx].subject=subject; hw[cls][idx].teacher=teacher; hw[cls][idx].details=details; hw[cls][idx].date=date; }
      } else {
        hw[cls].push({ id: uid(), subject, teacher, details, date });
      }
      store(K_HOMEWORK, hw);
      renderHomework(); clearHwForm();
    }
    function editHw(cls,id){
      const hw = parse(K_HOMEWORK,{});
      const item = (hw[cls]||[]).find(x=>x.id === id);
      if(!item) return alert('Not found');
      $('hwClass').value = cls;
      $('hwSubject').value = item.subject;
      $('hwText').value = item.details;
      $('hwDate').value = item.date || new Date().toISOString().slice(0,10);
      $('hwEditId').value = item.id;
      renderTeachersSelect();
      $('hwTeacher').value = item.teacher || '';
      openTab('homework');
    }
    function delHw(cls,id){ showConfirm('Delete homework','Delete this homework?', 'Delete', ()=>{ const hw = parse(K_HOMEWORK,{}); hw[cls] = (hw[cls]||[]).filter(x=>x.id!==id); store(K_HOMEWORK, hw); renderHomework(); }); }
    function bulkAddSample(){ const hw = parse(K_HOMEWORK,{}); for(let i=1;i<=12;i++){ hw[i] = hw[i] || []; hw[i].push({ id: uid(), subject: 'General', teacher: 'Staff', details: `Bulk sample for class ${i}`, date: new Date().toISOString().slice(0,10) }); } store(K_HOMEWORK, hw); renderHomework(); }

    /* ---------- Teachers CRUD ---------- */
    function renderTeachers(){
      const arr = parse(K_TEACHERS,[]);
      const tbody = $('teachersTable'); tbody.innerHTML='';
      arr.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escape(t.name)}</td><td>${escape(t.subject)}</td><td>${escape(t.phone||'')}</td><td><button class="btn" onclick="editTeacher('${t.id}')">Edit</button> <button class="btn ghost" onclick="delTeacher('${t.id}')">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      renderTeachersSelect();
      updateStats();
    }
    function renderTeachersSelect(){
      const sel = $('hwTeacher'); if(!sel) return;
      sel.innerHTML = '<option value="">--Select--</option>';
      parse(K_TEACHERS,[]).forEach(t=>{ const o=document.createElement('option'); o.value = t.name; o.textContent = `${t.name} (${t.subject})`; sel.appendChild(o); });
    }
    function openTeacherForm(){ openTab('teachers'); clearTeacherForm(); }
    function clearTeacherForm(){ $('tName').value=''; $('tSubject').value=''; $('tPhone').value=''; $('tEmail').value=''; $('tEditId').value=''; }
    function saveTeacher(){
      const name = $('tName').value.trim(); const subject = $('tSubject').value.trim();
      if(!name || !subject) return alert('Name & subject required');
      const phone = $('tPhone').value.trim(); const email = $('tEmail').value.trim();
      const arr = parse(K_TEACHERS,[]);
      const editId = $('tEditId').value;
      if(editId){
        const idx = arr.findIndex(x=>x.id===editId); if(idx>=0){ arr[idx].name=name; arr[idx].subject=subject; arr[idx].phone=phone; arr[idx].email=email; }
      } else arr.push({ id: uid(), name, subject, phone, email });
      store(K_TEACHERS, arr);
      renderTeachers(); clearTeacherForm();
    }
    function editTeacher(id){
      const arr = parse(K_TEACHERS,[]); const t = arr.find(x=>x.id===id); if(!t) return;
      $('tName').value = t.name; $('tSubject').value = t.subject; $('tPhone').value = t.phone || ''; $('tEmail').value = t.email || ''; $('tEditId').value = t.id; openTab('teachers');
    }
    function delTeacher(id){ showConfirm('Delete teacher','Delete this teacher?', 'Delete', ()=>{ store(K_TEACHERS, parse(K_TEACHERS,[]).filter(x=>x.id!==id)); renderTeachers(); }); }

    /* ---------- Events CRUD ---------- */
    function renderEvents(){
      const arr = parse(K_EVENTS,[]);
      const tbody = $('eventsTable'); tbody.innerHTML='';
      arr.forEach(ev=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escape(ev.date)}</td><td>${escape(ev.title)}</td><td style="max-width:360px">${escape(ev.desc||'')}</td><td><button class="btn" onclick="editEvent('${ev.id}')">Edit</button> <button class="btn ghost" onclick="delEvent('${ev.id}')">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      updateStats();
    }
    function openEventForm(){ openTab('events'); clearEventForm(); }
    function clearEventForm(){ $('eTitle').value=''; $('eDate').value=''; $('eDesc').value=''; $('eEditId').value=''; }
    function saveEvent(){
      const title = $('eTitle').value.trim(); const date = $('eDate').value; const desc = $('eDesc').value.trim();
      if(!title || !date) return alert('Title & date required');
      const arr = parse(K_EVENTS,[]);
      const editId = $('eEditId').value;
      if(editId){ const idx = arr.findIndex(x=>x.id===editId); if(idx>=0){ arr[idx].title=title; arr[idx].date=date; arr[idx].desc=desc; } }
      else arr.push({ id: uid(), title, date, desc });
      store(K_EVENTS, arr); renderEvents(); clearEventForm();
    }
    function editEvent(id){ const arr=parse(K_EVENTS,[]); const e=arr.find(x=>x.id===id); if(!e) return; $('eTitle').value=e.title; $('eDate').value=e.date; $('eDesc').value=e.desc; $('eEditId').value=e.id; openTab('events'); }
    function delEvent(id){ showConfirm('Delete event','Delete this event?', 'Delete', ()=>{ store(K_EVENTS, parse(K_EVENTS,[]).filter(x=>x.id!==id)); renderEvents(); }); }

    /* ---------- Notices CRUD ---------- */
    function renderNotices(){
      const arr = parse(K_NOTICES,[]);
      const tbody = $('noticesTable'); tbody.innerHTML='';
      arr.forEach(n=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escape(n.title)}</td><td style="max-width:360px">${escape(n.body)}</td><td>${escape(n.priority)}</td><td><button class="btn" onclick="editNotice('${n.id}')">Edit</button> <button class="btn ghost" onclick="delNotice('${n.id}')">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function openNoticeForm(){ openTab('notices'); clearNoticeForm(); }
    function clearNoticeForm(){ $('nTitle').value=''; $('nBody').value=''; $('nPriority').value='low'; $('nEditId').value=''; }
    function saveNotice(){ const title=$('nTitle').value.trim(); const body=$('nBody').value.trim(); const pr=$('nPriority').value; if(!title||!body) return alert('Title & body required'); const arr=parse(K_NOTICES,[]); const editId=$('nEditId').value; if(editId){ const idx=arr.findIndex(x=>x.id===editId); if(idx>=0){ arr[idx].title=title; arr[idx].body=body; arr[idx].priority=pr; } } else arr.push({ id: uid(), title, body, priority: pr }); store(K_NOTICES, arr); renderNotices(); clearNoticeForm(); }
    function editNotice(id){ const arr=parse(K_NOTICES,[]); const n=arr.find(x=>x.id===id); if(!n) return; $('nTitle').value=n.title; $('nBody').value=n.body; $('nPriority').value=n.priority; $('nEditId').value=n.id; openTab('notices'); }
    function delNotice(id){ showConfirm('Delete notice','Delete this notice?', 'Delete', ()=>{ store(K_NOTICES, parse(K_NOTICES,[]).filter(x=>x.id!==id)); renderNotices(); }); }

    /* ---------- Timetable CRUD ---------- */
    function renderTimetable(){
      const tt = parse(K_TIMETABLE,{});
      const tbody = $('timetableTable'); tbody.innerHTML='';
      for(const day in tt){
        const slots = tt[day]||[];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escape(day)}</td><td>${escape(slots[0]||'')}</td><td>${escape(slots[1]||'')}</td><td>${escape(slots[2]||'')}</td><td>${escape(slots[3]||'')}</td><td><button class="btn" onclick="editTimetable('${day}')">Edit</button> <button class="btn ghost" onclick="delTimetable('${day}')">Delete</button></td>`;
        tbody.appendChild(tr);
      }
    }
    function openTimetableForm(){ openTab('timetable'); clearTimetableForm(); }
    function clearTimetableForm(){ $('ttDay').value=''; $('tt1').value=''; $('tt2').value=''; $('tt3').value=''; $('tt4').value=''; $('ttEditId').value=''; }
    function saveTimetable(){ const day=$('ttDay').value.trim(); if(!day) return alert('Day required'); const slots=[ $('tt1').value, $('tt2').value, $('tt3').value, $('tt4').value ]; const tt=parse(K_TIMETABLE,{}); const editId=$('ttEditId').value; if(editId && editId!==day) delete tt[editId]; tt[day]=slots; store(K_TIMETABLE, tt); renderTimetable(); clearTimetableForm(); }
    function editTimetable(day){ const tt=parse(K_TIMETABLE,{}); const s=tt[day]||[]; $('ttDay').value=day; $('tt1').value=s[0]||''; $('tt2').value=s[1]||''; $('tt3').value=s[2]||''; $('tt4').value=s[3]||''; $('ttEditId').value=day; openTab('timetable'); }
    function delTimetable(day){ showConfirm('Delete row','Delete timetable for '+day+'?', 'Delete', ()=>{ const tt=parse(K_TIMETABLE,{}); delete tt[day]; store(K_TIMETABLE, tt); renderTimetable(); }); }

    /* ---------- Gallery CRUD ---------- */
    function renderGallery(){
      const arr = parse(K_GALLERY,[]);
      const tbody = $('galleryTable'); tbody.innerHTML='';
      arr.forEach((url,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><img src="${escape(url)}" style="height:48px;border-radius:6px;object-fit:cover"></td><td style="max-width:420px;word-break:break-all">${escape(url)}</td><td><button class="btn" onclick="editGallery(${idx})">Edit</button> <button class="btn ghost" onclick="delGallery(${idx})">Delete</button></td>`; tbody.appendChild(tr); });
    }
    function openGalleryForm(){ openTab('gallery'); clearGalleryForm(); }
    function clearGalleryForm(){ $('gUrl').value=''; $('gEditId').value=''; }
    function saveGallery(){ const url=$('gUrl').value.trim(); if(!url) return alert('URL required'); const arr=parse(K_GALLERY,[]); const editId=$('gEditId').value; if(editId){ arr[parseInt(editId,10)] = url; } else arr.push(url); store(K_GALLERY, arr); renderGallery(); clearGalleryForm(); }
    function editGallery(idx){ const arr=parse(K_GALLERY,[]); $('gUrl').value = arr[idx] || ''; $('gEditId').value = idx; openTab('gallery'); }
    function delGallery(idx){ showConfirm('Delete photo','Remove this photo?', 'Delete', ()=>{ const arr=parse(K_GALLERY,[]); arr.splice(idx,1); store(K_GALLERY, arr); renderGallery(); }); }

    /* ---------- Messages ---------- */
    function renderMessages(){
      const msgs = parse(K_MESSAGES,[]);
      const tbody = $('messagesTable'); tbody.innerHTML='';
      msgs.forEach((m,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(m.ts||Date.now()).toLocaleString()}</td><td>${escape(m.name)}</td><td>${escape(m.email||'')}</td><td style="max-width:420px">${escape(m.msg)}</td><td><button class="btn" onclick="toggleRead(${idx})">${m.read? 'Mark Unread':'Mark Read'}</button> <button class="btn ghost" onclick="delMessage(${idx})">Delete</button></td>`; tbody.appendChild(tr); });
      updateStats();
    }
    function toggleRead(i){ const msgs=parse(K_MESSAGES,[]); msgs[i].read = !msgs[i].read; store(K_MESSAGES, msgs); renderMessages(); }
    function delMessage(i){ showConfirm('Delete message','Delete this message?', 'Delete', ()=>{ const msgs = parse(K_MESSAGES,[]); msgs.splice(i,1); store(K_MESSAGES, msgs); renderMessages(); }); }
    function markAllRead(){ const msgs = parse(K_MESSAGES,[]); msgs.forEach(m=>m.read=true); store(K_MESSAGES, msgs); renderMessages(); }

    /* ---------- Storage viewer ---------- */
    function populateLSKeys(){
      const keys = [K_STUDENT,K_HOMEWORK,K_TEACHERS,K_EVENTS,K_NOTICES,K_TIMETABLE,K_GALLERY,K_MESSAGES];
      const sel = $('lsKeySelect'); sel.innerHTML='';
      keys.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
    }
    populateLSKeys();
    function viewLS(){ const key=$('lsKeySelect').value; if(!key) return; const v = localStorage.getItem(key); $('lsViewer').textContent = v ? JSON.stringify(JSON.parse(v), null, 2) : '// key not present'; $('lsEditor').value = v ? JSON.stringify(JSON.parse(v), null, 2) : ''; }
    function deleteLS(){ const key = $('lsKeySelect').value; if(!key) return; showConfirm('Delete key','Delete '+key+'?', 'Delete', ()=>{ localStorage.removeItem(key); localStorage.setItem(K_UPDATE, Date.now().toString()); viewLS(); renderAll(); }); }
    function saveLS(){ const key=$('lsKeySelect').value; const raw=$('lsEditor').value.trim(); if(!key) return alert('Select key'); if(!raw) return alert('Editor empty'); try{ const parsed = JSON.parse(raw); localStorage.setItem(key, JSON.stringify(parsed)); localStorage.setItem(K_UPDATE, Date.now().toString()); alert('Saved'); viewLS(); renderAll(); } catch(e){ alert('Invalid JSON: '+e.message); } }
    function clearEditor(){ $('lsEditor').value=''; }

    /* ---------- Snapshot ---------- */
    function downloadSnapshot(){
      const hw = parse(K_HOMEWORK,{});
      let html = '<!doctype html><html><head><meta charset="utf-8"><title>MKPS Snapshot</title></head><body><h1>Milli Karwaan Public School — Snapshot</h1>';
      for(const c in hw){ html += `<h2>Class ${escape(c)}</h2><ul>`; (hw[c]||[]).forEach(h=> html += `<li><strong>${escape(h.subject)}</strong> — ${escape(h.details)}</li>`); html += '</ul>'; }
      html += `<p>Generated: ${new Date().toLocaleString()}</p></body></html>`;
      const blob = new Blob([html], {type:'text/html'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mkps-snapshot.html'; a.click(); URL.revokeObjectURL(url);
    }

    /* ---------- UI helpers ---------- */
    function escape(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function updateStats(){
      const hw = parse(K_HOMEWORK,{}); let count=0; for(const k in hw) count += (hw[k]||[]).length;
      $('statHW').textContent = count;
      $('statTeachers').textContent = parse(K_TEACHERS,[]).length;
      $('statEvents').textContent = parse(K_EVENTS,[]).length;
      $('statMsgs').textContent = parse(K_MESSAGES,[]).filter(m=>!m.read).length;
      $('updatedBadge').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      const msgs = parse(K_MESSAGES,[]).slice(0,3);
      $('recentAct').innerHTML = msgs.length ? ('Recent msgs:<ul>'+msgs.map(m=>`<li>${escape(m.name)}: ${escape((m.msg||'').slice(0,40))}...</li>`).join('')+'</ul>') : 'No recent activity';
    }

    /* ---------- Tab navigation ---------- */
    document.querySelectorAll('#menuNav button').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('#menuNav button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const tab = b.dataset.tab;
        document.querySelectorAll('.tab').forEach(s=>s.classList.add('hidden'));
        const el = document.getElementById('tab-'+tab);
        if(el) el.classList.remove('hidden');
        // render what is needed
        if(tab==='homework') renderHomework();
        if(tab==='teachers') renderTeachers();
        if(tab==='events') renderEvents();
        if(tab==='notices') renderNotices();
        if(tab==='timetable') renderTimetable();
        if(tab==='gallery') renderGallery();
        if(tab==='messages') renderMessages();
        if(tab==='storage'){ populateLSKeys(); viewLS(); }
      });
    });

    function openTab(name){
      const btn = Array.from(document.querySelectorAll('#menuNav button')).find(b=>b.dataset.tab===name);
      if(btn) btn.click();
    }

    /* ---------- Render all ---------- */
    function renderAll(){
      renderHomework(); renderTeachers(); renderEvents(); renderNotices(); renderTimetable(); renderGallery(); renderMessages(); populateLSKeys(); updateStats();
    }
    window.renderAll = renderAll; // allow index to call if needed

    /* ---------- Storage change listener: if other tab updates mkps_update, refresh UI ---------- */
    window.addEventListener('storage', (e)=>{
      if(e.key === K_UPDATE){
        renderAll();
        $('updatedBadge').textContent = 'Updated (other): ' + new Date().toLocaleTimeString();
      }
    });

    /* ---------- Init UI ---------- */
    function initUI(viewOnly=false){
      // if no keys exist, seed minimal so interface has content (doesn't overwrite student)
      if(!localStorage.getItem(K_HOMEWORK)) seedDefaults();
      if(!localStorage.getItem(K_TEACHERS)) store(K_TEACHERS, []);
      if(!localStorage.getItem(K_EVENTS)) store(K_EVENTS, []);
      if(!localStorage.getItem(K_NOTICES)) store(K_NOTICES, []);
      if(!localStorage.getItem(K_TIMETABLE)) store(K_TIMETABLE, {});
      if(!localStorage.getItem(K_GALLERY)) store(K_GALLERY, []);
      if(!localStorage.getItem(K_MESSAGES)) store(K_MESSAGES, []);
      populateClassOptions();
      populateLSKeys();
      renderAll();
      openTab('dashboard');
    }

    /* ---------- Confirm wrappers for seeds / clears ---------- */
    function seedConfirm(){ showConfirm('Seed sample data', 'This will write sample mkps_* data (does not overwrite mkps_student). Proceed?', 'Seed', seedDefaults); }
    function clearAllConfirm(){ showConfirm('Clear all mkps_* data', 'This will remove mkps_* keys. Continue?', 'Clear', clearAll); }

    /* ---------- Auto-init if session says logged in ---------- */
    (function autoInit(){
      if(sessionStorage.getItem('mkps_admin_logged_in') === '1'){
        $('loginCard').classList.add('hidden');
        $('adminUI').classList.remove('hidden');
        initUI(false);
      }
    })();

    /* ---------- Utility: safer on older browsers ---------- */
    try { /* noop to keep console quiet */ } catch(e){}

  </script>
</body>
</html>
